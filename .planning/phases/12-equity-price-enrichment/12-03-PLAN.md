---
phase: 12-equity-price-enrichment
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - app/services/reporter.py
  - app/templates/report_professional.html
autonomous: true

must_haves:
  truths:
    - "Browser report pages show equity chips (ticker, price, change%) next to insurer sections that have a configured ticker"
    - "Email reports show the same equity data in an email-compatible layout that renders in Outlook and Gmail"
    - "Insurers without ticker mappings show no equity chip (graceful absence, not an error)"
    - "When equity API is unavailable, reports generate normally without equity chips"
    - "Currency displays as R$ (Brazilian Real) not USD"
  artifacts:
    - path: "app/services/reporter.py"
      provides: "Equity data pass-through from pipeline to template context"
      contains: "equity_data"
    - path: "app/templates/report_professional.html"
      provides: "Equity chip display with email-compatible inline styles"
      contains: "equity-chip"
  key_links:
    - from: "app/services/reporter.py"
      to: "app/routers/runs.py"
      via: "equity_data parameter threaded from pipeline enrichment"
      pattern: "equity_data"
    - from: "app/templates/report_professional.html"
      to: "app/services/reporter.py"
      via: "equity_by_insurer template variable rendered in insurer sections"
      pattern: "equity_by_insurer"
---

<objective>
Add equity price chip display to the professional report template, visible in both browser rendering and email delivery.

Purpose: Completes the user-facing equity enrichment feature — senior management sees real-time B3 stock prices for tracked Brazilian insurers directly in their daily intelligence reports, both on the web and in their email inbox.

Output: Updated reporter.py that passes equity data to the template, and updated report_professional.html with email-compatible equity chip markup.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-equity-price-enrichment/12-CONTEXT.md
@.planning/phases/12-equity-price-enrichment/12-RESEARCH.md
@.planning/phases/12-equity-price-enrichment/12-01-SUMMARY.md

Key reference: MDInsights browser chip at C:\BrasilIntel\mdinsights\app\templates\role_brief.html
Key reference: MDInsights email chip at C:\BrasilIntel\mdinsights\app\templates\email\role_email.html

CRITICAL CONTEXT: BrasilIntel has ONE template (report_professional.html) used for BOTH browser display AND email body. There is no separate email template. The GraphEmailService sends the rendered report_professional.html directly as html_body. Therefore:
- ALL styles must be inline (no external CSS, no <style> block references)
- NO flexbox or grid in the equity chip markup (Outlook uses Word rendering engine)
- Use table-based layout for the equity chip row to ensure Outlook/Gmail compatibility
- Use inline-block spans as a simpler alternative where a single chip is sufficient

Equity data flow (from Plan 12-01):
- Pipeline _enrich_equity_data() returns dict: {insurer_id: [price_dict, ...]}
- price_dict = {"ticker": "SULA11", "exchange": "BVMF", "price": 25.30, "change": 0.45, "change_pct": 1.81}
- equity_data is threaded through _generate_and_send_report → reporter.generate_professional_report_from_db
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread equity data through reporter service to template</name>
  <files>app/services/reporter.py</files>
  <action>
Update app/services/reporter.py to accept and pass equity data to the report template.

1. Update generate_professional_report() method signature:
   - Add parameter: equity_data: dict = None
   - Default to empty dict if None: equity_data = equity_data or {}
   - Pass equity_by_insurer=equity_data to template.render() call (line ~378)

2. Update generate_professional_report_from_db() method signature:
   - Add parameter: equity_data: dict = None
   - Pass equity_data through to the call to self.generate_professional_report() (line ~462)

3. Update _generate_and_send_report() in app/routers/runs.py (if not already done in 12-01):
   - The function should accept equity_data parameter
   - Pass equity_data to report_service.generate_professional_report_from_db()

The template will receive equity_by_insurer as a dict: {insurer_id: [price_dict, ...]}. Each price_dict has keys: ticker, exchange, price, change, change_pct. Any of the numeric values may be None.

IMPORTANT: The equity_data default must be empty dict (not None) so Jinja2 can safely call .get() on it without errors. Ensure backward compatibility — if equity_data is not provided, reports render exactly as before with no equity chips.
  </action>
  <verify>
- generate_professional_report() accepts equity_data keyword argument
- generate_professional_report_from_db() accepts and passes equity_data through
- Template render call includes equity_by_insurer in context
- Reports still render correctly when equity_data is empty dict or None
- python -c "from app.services.reporter import ReportService; print('OK')" succeeds
  </verify>
  <done>Equity data flows from pipeline through reporter service to template context, with backward-compatible defaults</done>
</task>

<task type="auto">
  <name>Task 2: Add email-compatible equity chips to professional report template</name>
  <files>app/templates/report_professional.html</files>
  <action>
Add equity price chip display to app/templates/report_professional.html inside each insurer section.

Insert the equity chip markup INSIDE the insurer-header div, right after the insurer name h2 and before the code badges div. This placement puts the price data next to the insurer name where it's most visible.

Location: Find the insurer section loop (around line 798-803):
```html
{% for insurer in status_insurers %}
<section class="insurer-section">
    <div class="insurer-header">
        <div>
            <h2>{{ insurer.name }}</h2>
            <!-- INSERT EQUITY CHIPS HERE -->
            <div class="insurer-codes">
```

Insert this equity chip block between h2 and insurer-codes div:

```html
{% if equity_by_insurer and equity_by_insurer.get(insurer.id) %}
<div style="margin-top: 6px; margin-bottom: 8px;">
    {% for eq in equity_by_insurer.get(insurer.id, []) %}
    <span style="display: inline-block; background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 4px 10px; border-radius: 4px; font-size: 0.75em; font-weight: 600; margin-right: 6px; margin-bottom: 4px; vertical-align: middle;">
        <span style="color: #00263e;">{{ eq.ticker }}</span>
        {% if eq.price is not none %}
        <span style="color: #495057; margin-left: 4px;">R$&nbsp;{{ "%.2f"|format(eq.price) }}</span>
        {% endif %}
        {% if eq.change_pct is not none %}
        {% if eq.change_pct > 0 %}
        <span style="color: #198754; margin-left: 4px;">&#9650;&nbsp;{{ "%.2f"|format(eq.change_pct) }}%</span>
        {% elif eq.change_pct < 0 %}
        <span style="color: #dc3545; margin-left: 4px;">&#9660;&nbsp;{{ "%.2f"|format(eq.change_pct|abs) }}%</span>
        {% else %}
        <span style="color: #6c757d; margin-left: 4px;">&mdash;</span>
        {% endif %}
        {% endif %}
    </span>
    {% endfor %}
</div>
{% endif %}
```

Key design decisions for email compatibility:
- ALL styles are inline (no CSS class references — the template CSS classes like .equity-chip won't survive email client processing)
- Use `display: inline-block` (not flex) for chip layout
- Use HTML entities for arrows: &#9650; (▲) and &#9660; (▼) instead of Unicode chars (safer in Outlook)
- Use `&nbsp;` for non-breaking space between currency and amount
- Color scheme matches Marsh brand: #00263e (ticker), #198754 (green/positive), #dc3545 (red/negative), #6c757d (neutral)
- R$ currency format for Brazilian Real
- Font size 0.75em keeps chips compact next to insurer heading
- Graceful absence: {% if equity_by_insurer and equity_by_insurer.get(insurer.id) %} — no output when no data

Also add a CSS class in the template's existing <style> block for browser enhancement (progressive enhancement — emails strip this but browsers use it):
```css
/* Equity price chips - inline styles are primary (email), CSS is progressive enhancement (browser) */
.equity-chip-container {
    margin-top: 6px;
    margin-bottom: 8px;
}
```

Add class="equity-chip-container" to the wrapper div alongside the inline styles for browser-only enhancement.

IMPORTANT: The Jinja2 `|abs` filter is needed for negative change_pct display. Verify that Jinja2 supports this filter (it does natively as of Jinja2 3.0+).
  </action>
  <verify>
- Equity chip markup appears inside insurer-section, between h2 and insurer-codes div
- All styles are inline (grep for 'style=' in the equity section)
- No CSS class dependencies for core display (classes only for progressive enhancement)
- HTML entities &#9650; &#9660; used for arrows (not Unicode chars)
- R$ currency format used
- Conditional rendering: chips only show when equity_by_insurer has data for the insurer
- No equity markup visible when equity_by_insurer is empty dict
- Template renders without error when equity_by_insurer is undefined (check {% if equity_by_insurer and ... %})
  </verify>
  <done>Equity chips display next to insurer names in the professional report, using email-compatible inline styles that render correctly in both browser and Outlook/Gmail</done>
</task>

</tasks>

<verification>
1. Reports render correctly with equity data: chips show ticker, R$ price, colored change%
2. Reports render correctly WITHOUT equity data: no equity markup in output
3. Positive change shows green ▲, negative shows red ▼, zero shows grey dash
4. All equity chip styles are inline (email-safe)
5. No use of flexbox, grid, or external CSS classes for core display
6. R$ currency format used (not $)
7. Template renders without errors when equity_by_insurer is empty, None, or not provided
</verification>

<success_criteria>
- Equity chips visible in browser report pages next to insurer headings
- Same equity chips survive email rendering in Outlook and Gmail (inline styles only)
- Graceful absence when no ticker configured for an insurer
- Graceful degradation when equity API was unavailable (empty data = no chips)
- R$ Brazilian Real currency formatting
- No breaking changes to existing report layout
</success_criteria>

<output>
After completion, create `.planning/phases/12-equity-price-enrichment/12-03-SUMMARY.md`
</output>
