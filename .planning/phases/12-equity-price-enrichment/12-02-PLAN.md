---
phase: 12-equity-price-enrichment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/admin.py
  - app/templates/admin/equity.html
  - app/templates/admin/base.html
autonomous: true

must_haves:
  truths:
    - "Admin can view all existing ticker mappings on /admin/equity"
    - "Admin can add a new insurer-to-ticker mapping via the form"
    - "Admin can edit an existing ticker mapping"
    - "Admin can delete a ticker mapping with confirmation"
    - "Duplicate entity_name is rejected with an error message"
    - "Sidebar navigation includes an Equity Tickers link"
    - "5 major Brazilian insurer tickers are seeded as defaults"
  artifacts:
    - path: "app/routers/admin.py"
      provides: "CRUD routes for EquityTicker: list, add, edit, delete"
      contains: "admin_equity"
    - path: "app/templates/admin/equity.html"
      provides: "Ticker management page with list table and add form"
      contains: "Ticker Mappings"
    - path: "app/templates/admin/base.html"
      provides: "Sidebar nav with Equity Tickers link"
      contains: "equity"
  key_links:
    - from: "app/routers/admin.py"
      to: "app/models/equity_ticker.py"
      via: "SQLAlchemy CRUD operations on EquityTicker model"
      pattern: "EquityTicker"
    - from: "app/templates/admin/equity.html"
      to: "app/templates/admin/base.html"
      via: "extends base.html with block content"
      pattern: "extends.*base"
    - from: "app/templates/admin/base.html"
      to: "app/routers/admin.py"
      via: "url_for('admin_equity') sidebar link"
      pattern: "admin_equity"
---

<objective>
Build the admin dashboard interface for managing insurer-to-ticker mappings and seed default Brazilian insurer tickers.

Purpose: Enables administrators to configure which tracked insurers have B3 ticker symbols, so the equity enrichment step (Plan 12-01) can match insurers to their stock prices.

Output: Admin CRUD routes, equity.html template, sidebar nav entry, and 5 seeded default tickers for major Brazilian insurers.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-equity-price-enrichment/12-CONTEXT.md
@.planning/phases/12-equity-price-enrichment/12-RESEARCH.md

Key reference: MDInsights admin equity routes at C:\BrasilIntel\mdinsights\app\routers\admin.py (lines ~1508-1700)
Key reference: MDInsights equity template at C:\BrasilIntel\mdinsights\app\templates\admin\equity.html

Existing admin infrastructure:
- Router: app/routers/admin.py (existing CRUD patterns for insurers, recipients, schedules, settings)
- Base template: app/templates/admin/base.html (Bootstrap 5.3.3 + HTMX + sidebar nav)
- EquityTicker model: app/models/equity_ticker.py (entity_name, ticker, exchange, enabled, updated_at, updated_by)
- Auth: verify_admin dependency for all admin routes

Admin routing pattern: Standard form POST with RedirectResponse + flash messages via URL query params (?success=, ?error=). NOT HTMX.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add equity ticker CRUD routes to admin router</name>
  <files>app/routers/admin.py</files>
  <action>
Add equity ticker management routes to app/routers/admin.py. Follow the exact patterns established by the existing insurer/recipient/schedule routes.

1. Add import at top:
   - from app.models.equity_ticker import EquityTicker

2. Add these route functions at the bottom of the file (before any final closing code):

   a. GET /admin/equity (name="admin_equity") — List all tickers page
      - Requires verify_admin dependency
      - Query all EquityTicker rows ordered by entity_name ASC
      - Render templates "admin/equity.html" with context: request, tickers, active="equity", username, success/error from query params
      - Read success/error from request.query_params.get("success"), request.query_params.get("error")

   b. POST /admin/equity (name="admin_equity_add") — Add new ticker
      - Form fields: entity_name, ticker, exchange (default "BVMF"), enabled (checkbox)
      - Validate: entity_name and ticker are required (non-empty after strip)
      - Validate: entity_name uniqueness (case-insensitive query with func.lower)
      - Ticker: strip and uppercase
      - Exchange: strip and uppercase, default to "BVMF" if empty
      - Enabled: parse checkbox ("on", "true", "1", "yes" = True)
      - On success: RedirectResponse to /admin/equity?success=Mapping+for+'{entity_name}'+added+successfully (status 303)
      - On validation error: RedirectResponse to /admin/equity?error={message} (status 303)

   c. GET /admin/equity/edit/{ticker_id} (name="admin_equity_edit") — Edit form page
      - Query EquityTicker by id, 404 if not found
      - Render "admin/equity.html" with context: request, tickers (all), edit_ticker (the one being edited), active="equity", username
      - The template will show the edit form pre-filled when edit_ticker is passed

   d. POST /admin/equity/edit/{ticker_id} (name="admin_equity_update") — Update ticker
      - Same validation as add
      - Check uniqueness excluding current row (func.lower match but id != ticker_id)
      - Update fields: entity_name, ticker, exchange, enabled, updated_at=datetime.utcnow()
      - On success: RedirectResponse to /admin/equity?success=Mapping+for+'{entity_name}'+updated

   e. POST /admin/equity/delete/{ticker_id} (name="admin_equity_delete") — Delete ticker
      - Query by id, 404 if not found
      - Delete and commit
      - RedirectResponse to /admin/equity?success=Mapping+deleted+successfully

   f. POST /admin/equity/seed (name="admin_equity_seed") — Seed default tickers
      - Insert 5 default Brazilian insurer tickers (only if they don't already exist by entity_name):
        - BB Seguridade → BBSE3 (BVMF)
        - SulAmerica → SULA11 (BVMF)
        - Porto Seguro → PSSA3 (BVMF)
        - IRB Brasil → IRBR3 (BVMF)
        - Caixa Seguridade → CXSE3 (BVMF)
      - Count how many were actually inserted (skip existing)
      - RedirectResponse to /admin/equity?success={count}+default+tickers+seeded

All routes use verify_admin dependency. All POST routes use status_code=303 for RedirectResponse.
  </action>
  <verify>
- python -c "from app.routers.admin import router; print(len(router.routes))" shows increased route count
- Routes registered: admin_equity, admin_equity_add, admin_equity_edit, admin_equity_update, admin_equity_delete, admin_equity_seed
- EquityTicker imported in admin.py
- All POST routes return RedirectResponse with status_code=303
  </verify>
  <done>Six equity admin routes exist: list, add, edit page, update, delete, seed — all following existing BrasilIntel admin patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create equity admin template and add sidebar nav</name>
  <files>app/templates/admin/equity.html, app/templates/admin/base.html</files>
  <action>
Create app/templates/admin/equity.html and add the Equity Tickers link to the sidebar.

**equity.html template** — Port from MDInsights equity.html (C:\BrasilIntel\mdinsights\app\templates\admin\equity.html) with these sections:

1. Extends admin/base.html, sets block title to "Equity Tickers"
2. Flash messages: Show success alert (bg-success) if success param, error alert (bg-danger) if error param
3. Ticker list table card:
   - Card header: "Ticker Mappings" with count badge
   - Table columns: Insurer Name, Ticker (in code tag), Exchange, Enabled (badge), Updated, Actions (Edit + Delete buttons)
   - Empty state: Bootstrap Icons graph-up icon with "No ticker mappings yet" message
   - Delete button wrapped in form with POST to /admin/equity/delete/{id} and JS confirm
4. Add/Edit form card (below the table):
   - If edit_ticker is set, show "Edit Mapping" title and pre-fill form fields; POST to /admin/equity/edit/{id}
   - If no edit_ticker, show "Add New Mapping" title; POST to /admin/equity
   - Form fields:
     - entity_name: text input, required, placeholder "e.g., SulAmerica"
     - ticker: text input, required, placeholder "e.g., SULA11"
     - exchange: text input, default "BVMF", placeholder "e.g., BVMF"
     - enabled: checkbox, checked by default (or checked if edit_ticker.enabled)
   - Submit button: "Save Mapping" or "Update Mapping" depending on mode
   - Cancel link (visible only in edit mode): returns to /admin/equity
5. Seed defaults card (at bottom):
   - Small card with "Seed Default Tickers" heading
   - Brief description: "Add 5 major Brazilian insurer tickers (BBSE3, SULA11, PSSA3, IRBR3, CXSE3)"
   - POST form to /admin/equity/seed with a "Seed Defaults" button (btn-outline-secondary)

Use Bootstrap 5.3.3 classes matching existing admin pages. Use Bootstrap Icons (bi-graph-up, bi-pencil, bi-trash, bi-plus-circle).

**base.html sidebar** — Add Equity Tickers nav link after the Settings link:
```html
<a class="nav-link {% if active == 'equity' %}active{% endif %}" href="{{ url_for('admin_equity') }}">
    <i class="bi bi-graph-up"></i>Equity Tickers
</a>
```
Insert this AFTER the Settings nav-link and BEFORE the closing </nav> tag.
  </action>
  <verify>
- app/templates/admin/equity.html exists
- Template extends admin/base.html
- Contains form with entity_name, ticker, exchange, enabled fields
- Contains table with insurer name, ticker, exchange, enabled, updated, actions columns
- Contains seed defaults form
- app/templates/admin/base.html sidebar contains "equity" nav-link with bi-graph-up icon
- Browse to /admin/equity shows the page (after app startup)
  </verify>
  <done>Equity ticker management page renders with list table, add/edit form, seed defaults button, and sidebar navigation link</done>
</task>

</tasks>

<verification>
1. Admin sidebar shows "Equity Tickers" link with graph-up icon
2. GET /admin/equity shows empty state initially
3. POST /admin/equity with entity_name="Test" ticker="TEST3" creates mapping
4. Duplicate entity_name is rejected with error message
5. Edit link loads pre-filled form
6. Delete button with confirmation removes mapping
7. Seed defaults creates 5 Brazilian insurer tickers
8. All routes require admin authentication
</verification>

<success_criteria>
- Full CRUD for EquityTicker via admin dashboard
- 5 default Brazilian insurer tickers can be seeded
- Sidebar navigation updated with Equity Tickers link
- Follows existing BrasilIntel admin patterns (form POST + redirect + flash)
- No breaking changes to existing admin functionality
</success_criteria>

<output>
After completion, create `.planning/phases/12-equity-price-enrichment/12-02-SUMMARY.md`
</output>
