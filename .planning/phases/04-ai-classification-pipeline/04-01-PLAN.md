---
phase: 04-ai-classification-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/schemas/classification.py
  - app/models/news_item.py
  - app/services/classifier.py
  - app/routers/runs.py
autonomous: true

must_haves:
  truths:
    - "Classification includes explicit category indicators (financial_crisis, regulatory_action, m_and_a, leadership_change)"
    - "Category indicators are stored with news items in database"
    - "Classification prompt requests category indicators"
  artifacts:
    - path: "app/schemas/classification.py"
      provides: "NewsClassification with category_indicators field"
      contains: "category_indicators"
    - path: "app/models/news_item.py"
      provides: "NewsItem model with category_indicators column"
      contains: "category_indicators"
    - path: "app/services/classifier.py"
      provides: "Updated prompt requesting category indicators"
      contains: "category_indicators"
  key_links:
    - from: "app/routers/runs.py"
      to: "app/models/news_item.py"
      via: "Stores category_indicators from classification result"
      pattern: "category_indicators.*=.*classification"
---

<objective>
Enhance classification pipeline with explicit category indicators per CLASS-02.

Purpose: The existing classification returns status (Critical/Watch/Monitor/Stable) but doesn't expose WHICH criteria triggered it. Adding category_indicators field enables reports to show "why" an insurer is flagged (e.g., "M&A activity detected", "Regulatory action").

Output: Enhanced NewsClassification schema and NewsItem model storing category indicators.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-ai-classification-pipeline/04-RESEARCH.md

# Existing files to enhance
@app/schemas/classification.py
@app/models/news_item.py
@app/services/classifier.py
@app/routers/runs.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add category_indicators to NewsClassification schema</name>
  <files>app/schemas/classification.py</files>
  <action>
Enhance the existing NewsClassification Pydantic model to include category_indicators field:

1. Add a Literal type for the category indicators:
   ```python
   CategoryIndicator = Literal[
       "financial_crisis",      # Crise financeira, risco de falência
       "regulatory_action",     # Intervenção ANS, ações regulatórias
       "m_and_a",              # Fusões e aquisições
       "leadership_change",     # Mudanças de liderança
       "fraud_criminal",        # Fraude, acusações criminais
       "rate_change",          # Mudanças de tarifa
       "network_change",       # Alterações na rede
       "market_expansion",     # Expansão de mercado
       "partnership",          # Parcerias
       "routine_operations"    # Operações rotineiras
   ]
   ```

2. Add category_indicators field to NewsClassification:
   ```python
   category_indicators: list[CategoryIndicator] = Field(
       default_factory=list,
       description="Categories detected in the news content that influenced the status"
   )
   ```

Keep all existing fields intact. The new field should be added after the reasoning field.
  </action>
  <verify>python -c "from app.schemas.classification import NewsClassification; nc = NewsClassification(status='Watch', summary_bullets=['test'], sentiment='neutral', reasoning='test', category_indicators=['m_and_a']); print(f'category_indicators: {nc.category_indicators}')"</verify>
  <done>NewsClassification schema includes category_indicators field with Literal type validation</done>
</task>

<task type="auto">
  <name>Task 2: Add category_indicators column to NewsItem model and update storage</name>
  <files>app/models/news_item.py, app/routers/runs.py</files>
  <action>
1. In app/models/news_item.py, add category_indicators column:
   ```python
   # After the summary column, add:
   category_indicators = Column(String(500), nullable=True)  # Comma-separated list
   ```

2. In app/routers/runs.py, update BOTH locations where NewsItem is created to store category_indicators:

   **Location 1 - Single insurer mode (line 150-161):**
   After line 160 where `summary=...` is assigned, add:
   ```python
   category_indicators=",".join(classification.category_indicators) if classification and classification.category_indicators else None,
   ```

   **Location 2 - Category mode (lines 232-235):**
   After line 235 where `item.summary = ...` is assigned, add:
   ```python
   item.category_indicators = ",".join(classification.category_indicators) if classification.category_indicators else None
   ```

This stores the list as comma-separated string for simplicity (SQLite doesn't have native array type).
  </action>
  <verify>python -c "from app.models.news_item import NewsItem; print('category_indicators' in [c.name for c in NewsItem.__table__.columns])"</verify>
  <done>NewsItem model has category_indicators column and runs.py stores classification category_indicators in both single and category modes</done>
</task>

<task type="auto">
  <name>Task 3: Update classifier prompt to request category indicators</name>
  <files>app/services/classifier.py</files>
  <action>
Update SYSTEM_PROMPT_SINGLE to explicitly request category_indicators in the output:

Replace the existing SYSTEM_PROMPT_SINGLE with:
```python
SYSTEM_PROMPT_SINGLE = """Você é um analista financeiro especializado em seguradoras brasileiras.
Analise a notícia fornecida e classifique o status da seguradora.

Critérios de classificação:
- CRITICAL: Crise financeira, intervenção da ANS, risco de falência, fraude, acusações criminais
- WATCH: Atividade de M&A, mudanças significativas na liderança, ações regulatórias, perdas significativas
- MONITOR: Mudanças de tarifa, alterações na rede, expansão de mercado, anúncios de parcerias
- STABLE: Sem notícias significativas ou apenas atualizações operacionais rotineiras

Indicadores de categoria (inclua todos que se aplicam):
- financial_crisis: Crise financeira, problemas de solvência, risco de falência
- regulatory_action: Intervenção da ANS, multas, sanções, ações regulatórias
- m_and_a: Fusões, aquisições, vendas de operações
- leadership_change: Mudança de CEO, diretoria, conselho
- fraud_criminal: Fraude, investigações criminais, acusações
- rate_change: Reajustes de preços, mudanças tarifárias
- network_change: Alterações na rede credenciada, hospitais, médicos
- market_expansion: Novos mercados, expansão geográfica, novos produtos
- partnership: Parcerias, acordos comerciais, alianças
- routine_operations: Operações normais, sem eventos significativos

Responda em português brasileiro para todos os campos de texto."""
```

Also update the fallback_classification method to include category_indicators:
```python
def _fallback_classification(self) -> NewsClassification:
    """Return fallback classification when LLM is unavailable."""
    return NewsClassification(
        status="Monitor",
        summary_bullets=["Classificação automática indisponível"],
        sentiment="neutral",
        reasoning="Classificação de fallback - LLM não configurado ou desabilitado",
        category_indicators=["routine_operations"],
    )
```
  </action>
  <verify>python -c "from app.services.classifier import ClassificationService, SYSTEM_PROMPT_SINGLE; assert 'category_indicators' in SYSTEM_PROMPT_SINGLE.lower() or 'indicadores de categoria' in SYSTEM_PROMPT_SINGLE.lower(); print('Prompt includes category indicators')"</verify>
  <done>Classification prompt explicitly requests category indicators and fallback includes default category</done>
</task>

</tasks>

<verification>
1. Schema validation: `python -c "from app.schemas.classification import NewsClassification; print('Schema OK')"`
2. Model column exists: `python -c "from app.models.news_item import NewsItem; print([c.name for c in NewsItem.__table__.columns])"`
3. Prompt includes categories: `python -c "from app.services.classifier import SYSTEM_PROMPT_SINGLE; print('indicadores' in SYSTEM_PROMPT_SINGLE.lower())"`
4. Fallback works: `python -c "from app.services.classifier import ClassificationService; s = ClassificationService(); fc = s._fallback_classification(); print(f'Fallback category_indicators: {fc.category_indicators}')"`
</verification>

<success_criteria>
- NewsClassification has category_indicators: list[CategoryIndicator] field
- CategoryIndicator is a Literal type with 10 valid values
- NewsItem model has category_indicators column (String, nullable)
- runs.py stores classification.category_indicators as comma-separated string in both locations
- SYSTEM_PROMPT_SINGLE includes category indicator descriptions in Portuguese
- Fallback classification returns category_indicators=["routine_operations"]
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-classification-pipeline/04-01-SUMMARY.md`
</output>
