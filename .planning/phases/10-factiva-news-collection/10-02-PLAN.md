---
phase: 10-factiva-news-collection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/deduplicator.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "ArticleDeduplicator.deduplicate() accepts a list of article dicts and returns a shorter list with semantic duplicates merged"
    - "Articles with cosine similarity >= 0.85 on title+description embeddings are grouped as duplicates"
    - "Duplicate groups keep the earliest article (by published_at), longest description, and merged source_name"
    - "sentence-transformers is listed in requirements.txt as a Phase 10 dependency"
  artifacts:
    - path: "app/services/deduplicator.py"
      provides: "Semantic deduplication with UnionFind grouping and sentence-transformers embeddings"
      exports: ["ArticleDeduplicator"]
    - path: "requirements.txt"
      provides: "Updated dependencies including sentence-transformers"
      contains: "sentence-transformers"
  key_links:
    - from: "app/services/deduplicator.py"
      to: "sentence-transformers"
      via: "SentenceTransformer model all-MiniLM-L6-v2"
      pattern: "SentenceTransformer"
---

<objective>
Port MDInsights' ArticleDeduplicator to BrasilIntel for semantic deduplication of Factiva news articles, and add sentence-transformers to requirements.txt.

Purpose: Wire-service-heavy Factiva content produces many near-duplicate articles (same story from Reuters, Bloomberg, local outlets). The deduplicator uses sentence-transformers embeddings with 0.85 cosine similarity threshold to group duplicates, keeping the earliest article with the longest description and merged source names. This is proven in MDInsights production.

Output: `app/services/deduplicator.py` (ArticleDeduplicator + _UnionFind), updated `requirements.txt`
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# MDInsights reference implementation (port source):
@C:\BrasilIntel\MDInsights\app\services\deduplicator.py

# Existing requirements (add sentence-transformers):
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port ArticleDeduplicator from MDInsights</name>
  <files>app/services/deduplicator.py</files>
  <action>
Create `app/services/deduplicator.py` by porting from MDInsights (`C:\BrasilIntel\MDInsights\app\services\deduplicator.py`).

This is a nearly direct port — the deduplicator is source-agnostic and works on article dicts. Adaptations for BrasilIntel:

1. **Module docstring**: Update to say "BrasilIntel" not "MDInsights". Reference Factiva as the primary article source.

2. **Port both classes exactly**:
   - `_UnionFind`: Internal disjoint-set data structure. Copy verbatim.
   - `ArticleDeduplicator`: Full class with `__init__`, `_load_model`, `deduplicate`, `_merge_articles`. Copy verbatim.

3. **No field name changes needed**: The deduplicator operates on generic article dicts with keys `title`, `description`, `source_name`, `published_at`. These are the same keys FactivaCollector (Plan 10-01) outputs. No schema-specific coupling.

4. **Keep all logging**: structlog with service="deduplicator". All debug-level duplicate detection logs, info-level completion stats.

5. **Keep the 0.85 threshold default**: Proven for wire-service insurance content. RESEARCH.md says "0.85 cosine similarity threshold proven for wire-service content".

6. **Lazy model loading**: Keep `_load_model()` pattern — model loads on first `deduplicate()` call, not on import. This avoids 80MB model download during app startup.

7. **Imports**:
   - `import structlog`
   - `from datetime import datetime`
   - `from typing import List, Dict, Any, Optional`
   - `from sentence_transformers import SentenceTransformer, util`

8. **Do NOT add URL-based dedup in this class**. URL dedup is trivially handled at the caller level (dict comprehension on source_url). The ArticleDeduplicator focuses on semantic similarity which is the hard problem.
  </action>
  <verify>
Run `python -c "from app.services.deduplicator import ArticleDeduplicator; print('OK')"` — must succeed. Note: This will fail if sentence-transformers is not installed. Run after Task 2.
  </verify>
  <done>
ArticleDeduplicator class exists at app/services/deduplicator.py with _UnionFind, lazy model loading, 0.85 threshold, and merge logic (earliest article, longest description, merged sources).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sentence-transformers to requirements.txt</name>
  <files>requirements.txt</files>
  <action>
Add `sentence-transformers` to `requirements.txt` under a new Phase 10 section.

Append after the existing "Phase 9" section:

```
# Phase 10 - Factiva News Collection
sentence-transformers>=2.2.0
```

Then run `pip install sentence-transformers` to install the dependency.

Do NOT pin to exact version — use minimum version `>=2.2.0` (consistent with other deps in requirements.txt like `httpx>=0.27.0`).

After install, verify import works: `python -c "from sentence_transformers import SentenceTransformer; print('OK')"`.

Then verify the full deduplicator import chain: `python -c "from app.services.deduplicator import ArticleDeduplicator; d = ArticleDeduplicator(); print('OK')"`. Note: This will trigger model download on first run (~80MB for all-MiniLM-L6-v2). Allow time for download.
  </action>
  <verify>
`python -c "from app.services.deduplicator import ArticleDeduplicator; print('OK')"` prints OK without errors.
  </verify>
  <done>
requirements.txt contains sentence-transformers>=2.2.0, the package is installed, and ArticleDeduplicator can be imported and instantiated.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.services.deduplicator import ArticleDeduplicator"` — no import errors
2. `python -c "from app.services.deduplicator import ArticleDeduplicator; d = ArticleDeduplicator(); print(d.similarity_threshold)"` — prints 0.85
3. `grep "sentence-transformers" requirements.txt` — present in file
4. Test dedup with trivial input: `python -c "from app.services.deduplicator import ArticleDeduplicator; d = ArticleDeduplicator(); result = d.deduplicate([]); print('empty:', len(result))"` — prints "empty: 0"
</verification>

<success_criteria>
- ArticleDeduplicator class can be imported and instantiated
- Default threshold is 0.85
- Lazy model loading (model is None until first deduplicate() call)
- _UnionFind provides correct transitive grouping
- _merge_articles keeps earliest article, longest description, merged sources
- sentence-transformers in requirements.txt and installed
</success_criteria>

<output>
After completion, create `.planning/phases/10-factiva-news-collection/10-02-SUMMARY.md`
</output>
