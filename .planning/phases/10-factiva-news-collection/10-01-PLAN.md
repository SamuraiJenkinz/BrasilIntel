---
phase: 10-factiva-news-collection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/collectors/__init__.py
  - app/collectors/factiva.py
  - scripts/seed_factiva_config.py
autonomous: true

must_haves:
  truths:
    - "FactivaCollector.collect() sends a GET request to /coreapi/recent-news/v1/search with X-Api-Key header, industry codes, keywords, and 48-hour date window"
    - "FactivaCollector._fetch_article() retrieves individual article bodies and returns empty dict on 4xx errors (graceful fallback)"
    - "FactivaCollector._normalize_article() maps Factiva fields to BrasilIntel schema: title, description, source_url, source_name='Factiva', published_at"
    - "Every collect() call records an ApiEvent(type=NEWS_FETCH) with success/failure status and article count"
    - "FactivaConfig row id=1 is seeded with Brazilian insurance industry codes and Portuguese keywords"
  artifacts:
    - path: "app/collectors/__init__.py"
      provides: "Package init for collectors module"
      contains: "FactivaCollector"
    - path: "app/collectors/factiva.py"
      provides: "Complete Factiva API client with search, body fetch, normalize, event recording"
      exports: ["FactivaCollector"]
    - path: "scripts/seed_factiva_config.py"
      provides: "Seeds FactivaConfig id=1 with Brazilian insurance defaults"
  key_links:
    - from: "app/collectors/factiva.py"
      to: "app/config.py"
      via: "get_settings().mmc_api_base_url, get_settings().mmc_api_key"
      pattern: "get_settings\\(\\)"
    - from: "app/collectors/factiva.py"
      to: "app/models/api_event.py"
      via: "ApiEvent(event_type=ApiEventType.NEWS_FETCH)"
      pattern: "ApiEventType\\.NEWS_FETCH"
    - from: "app/collectors/factiva.py"
      to: "app/database.py"
      via: "SessionLocal() for event recording"
      pattern: "SessionLocal"
    - from: "scripts/seed_factiva_config.py"
      to: "app/models/factiva_config.py"
      via: "FactivaConfig ORM insert"
      pattern: "FactivaConfig"
---

<objective>
Port MDInsights' FactivaCollector to BrasilIntel as the complete Factiva API client — search, article body fetch, normalization, and ApiEvent recording. Seed FactivaConfig with Brazilian insurance defaults.

Purpose: This is the core news collection engine for Phase 10. The collector reads FactivaConfig from the database, queries Factiva's Recent News API with Brazilian insurance industry codes and Portuguese keywords, fetches individual article bodies for full-text content, normalizes results to BrasilIntel's article dict schema, and records all API interactions as ApiEvent records for dashboard observability.

Output: `app/collectors/factiva.py` (FactivaCollector class), `app/collectors/__init__.py` (package), `scripts/seed_factiva_config.py` (config seeder)
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 9 infrastructure (already built):
@app/config.py
@app/database.py
@app/models/api_event.py
@app/models/factiva_config.py

# MDInsights reference implementation (port source):
@C:\BrasilIntel\MDInsights\app\collectors\factiva.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FactivaCollector class</name>
  <files>app/collectors/__init__.py, app/collectors/factiva.py</files>
  <action>
Create `app/collectors/` package directory.

Create `app/collectors/__init__.py`:
```python
from app.collectors.factiva import FactivaCollector

__all__ = ["FactivaCollector"]
```

Create `app/collectors/factiva.py` by porting from MDInsights (`C:\BrasilIntel\MDInsights\app\collectors\factiva.py`) with these BrasilIntel-specific adaptations:

1. **Class docstring**: Update to say "BrasilIntel" not "MDInsights". Update field mapping to reference BrasilIntel's NewsItem schema (title, description, source_url, source_name, published_at).

2. **Date window**: Change from 1-day to 2-day (48 hours). The `collect()` method must use `timedelta(days=2)` not `timedelta(days=1)`. This is per CONTEXT.md: "Last 48 hours with dedup handling cross-run overlap".

3. **Normalization output schema**: The `_normalize_article()` method must return a dict with keys matching BrasilIntel's NewsItem fields:
   - `title` (from headline)
   - `description` (from plaintext body, fallback to snippet)
   - `source_url` (from article links.self or search links.self) — NOTE: BrasilIntel uses `source_url`, MDInsights uses `url`
   - `source_name` = "Factiva"
   - `published_at` (datetime from epoch milliseconds, naive UTC)
   Do NOT include `collector_source` (that's MDInsights-specific, not in BrasilIntel's NewsItem model).

4. **is_configured()**: Delegate to `get_settings().is_mmc_api_key_configured()` (already built in Phase 9) rather than checking self.base_url/api_key directly. This uses the canonical config guard.

5. **_record_event()**: Port directly from MDInsights — same pattern using SessionLocal(), ApiEvent, ApiEventType.NEWS_FETCH. The model and enums are identical (built in Phase 9).

6. **Imports**: Use BrasilIntel's import paths:
   - `from app.config import get_settings`
   - `from app.database import SessionLocal`
   - `from app.models.api_event import ApiEvent, ApiEventType`
   - `import httpx`, `import structlog`, `import json`
   - `from tenacity import retry, retry_if_exception_type, stop_after_attempt, wait_exponential`
   - `from datetime import datetime, timedelta, timezone`
   - `from typing import Any, Dict, List, Optional`

7. **Keep everything else from MDInsights**: `_build_headers()`, `_search()`, `_search_by_url()`, `_fetch_article()`, `_record_event()`, the pageSize100 pagination follow logic, the hard cap `MAX_ARTICLES = 100`, retry decorators on all HTTP methods.

8. **Do NOT use TokenManager** for this collector. X-Api-Key only. This is a critical anti-pattern from RESEARCH.md.
  </action>
  <verify>
Run `python -c "from app.collectors.factiva import FactivaCollector; c = FactivaCollector(); print('is_configured:', c.is_configured()); print('OK')"` — must print OK without import errors. is_configured will be False since no MMC credentials are set, which is expected.
  </verify>
  <done>
FactivaCollector class exists at app/collectors/factiva.py with all 7 methods (collect, _build_headers, _search, _search_by_url, _fetch_article, _normalize_article, _record_event), 48-hour date window, BrasilIntel-specific field mapping (source_url not url), and ApiEvent recording. Package __init__.py exports FactivaCollector.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FactivaConfig seed script</name>
  <files>scripts/seed_factiva_config.py</files>
  <action>
Create `scripts/seed_factiva_config.py` that inserts the default FactivaConfig row (id=1) with Brazilian insurance industry-specific values.

The script must:
1. Import SessionLocal, FactivaConfig from BrasilIntel's existing modules
2. Check if row id=1 already exists (idempotent — safe to run multiple times)
3. If not exists, insert with these defaults:
   - `industry_codes`: `"i82,i8200,i82001,i82002,i82003"` — i82=Insurance, i8200=Full Line Insurance, i82001=Life Insurance, i82002=Property and Casualty, i82003=Reinsurance
   - `company_codes`: `""` — empty, we rely on industry codes + keywords not company codes
   - `keywords`: `"seguro,seguradora,resseguro,saude suplementar,plano de saude,previdencia,sinistro,apolice,corretora de seguros"` — broad Portuguese insurance terms covering insurance, insurer, reinsurance, supplementary health, health plan, pension, claims, policy, insurance broker
   - `page_size`: `50` — balance between coverage and API cost (max 100)
   - `enabled`: `True`
4. Print confirmation message indicating what was done (inserted vs already exists)

Pattern: Follow existing scripts like `scripts/test_auth.py` for structure (import paths, if __name__ == "__main__" guard).

Do NOT add geographic filtering — per RESEARCH.md, start without geographic filter and rely on industry codes + keywords for relevance.
  </action>
  <verify>
Run `python scripts/seed_factiva_config.py` — must print either "Seeded FactivaConfig" or "FactivaConfig already exists". Run it twice to verify idempotency.
  </verify>
  <done>
scripts/seed_factiva_config.py exists, creates FactivaConfig id=1 with Brazilian insurance industry codes and Portuguese keywords, and is idempotent (safe to run multiple times).
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.collectors import FactivaCollector"` — no import errors
2. `python -c "from app.collectors.factiva import FactivaCollector; c = FactivaCollector(); print(type(c))"` — prints FactivaCollector class
3. `python scripts/seed_factiva_config.py` — seeds config without error
4. Verify FactivaCollector._normalize_article returns dict with key `source_url` (not `url`)
5. Verify FactivaCollector uses 48-hour date window (timedelta(days=2))
</verification>

<success_criteria>
- FactivaCollector class can be imported and instantiated without errors
- Collector has all 7 methods matching MDInsights patterns
- Normalization uses BrasilIntel field names (source_url, not url; no collector_source)
- 48-hour date window (not 24-hour)
- FactivaConfig seeded with Brazilian insurance defaults
- ApiEvent recording wired for NEWS_FETCH events
</success_criteria>

<output>
After completion, create `.planning/phases/10-factiva-news-collection/10-01-SUMMARY.md`
</output>
