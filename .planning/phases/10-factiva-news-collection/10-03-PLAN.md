---
phase: 10-factiva-news-collection
plan: 03
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - scripts/test_factiva.py
autonomous: true

must_haves:
  truths:
    - "Running test_factiva.py with valid MMC credentials fetches articles from Factiva, deduplicates them, and prints normalized results"
    - "Running test_factiva.py without MMC credentials exits gracefully with a clear 'not configured' message (exit code 0)"
    - "The script exercises the full Phase 10 flow: FactivaConfig read -> collect -> URL dedup -> semantic dedup -> normalize -> print summary"
    - "Each surviving article has all required fields: title, description, source_url, source_name='Factiva', published_at"
  artifacts:
    - path: "scripts/test_factiva.py"
      provides: "End-to-end validation script for Factiva collection + deduplication"
  key_links:
    - from: "scripts/test_factiva.py"
      to: "app/collectors/factiva.py"
      via: "FactivaCollector().collect(query_params)"
      pattern: "FactivaCollector"
    - from: "scripts/test_factiva.py"
      to: "app/services/deduplicator.py"
      via: "ArticleDeduplicator().deduplicate(articles)"
      pattern: "ArticleDeduplicator"
    - from: "scripts/test_factiva.py"
      to: "app/models/factiva_config.py"
      via: "Reads FactivaConfig row for query params"
      pattern: "FactivaConfig"
---

<objective>
Create a validation script that exercises the full Phase 10 pipeline: read FactivaConfig, collect articles from Factiva, apply URL dedup and semantic dedup, print results summary. This is the equivalent of Phase 9's test_auth.py — a standalone script to prove the phase works before pipeline integration in Phase 11.

Purpose: Validates that FactivaCollector and ArticleDeduplicator work together end-to-end with real Factiva API data. Provides a runnable proof that Phase 10 success criteria are met. Also serves as a diagnostic tool for credential and query tuning.

Output: `scripts/test_factiva.py`
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 10 dependencies (built in plans 01 and 02):
@app/collectors/factiva.py
@app/services/deduplicator.py
@app/models/factiva_config.py

# Phase 9 reference pattern:
@scripts/test_auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_factiva.py validation script</name>
  <files>scripts/test_factiva.py</files>
  <action>
Create `scripts/test_factiva.py` following the pattern established by `scripts/test_auth.py` (Phase 9).

The script must:

1. **Logging setup**: Use `logging.basicConfig(level=logging.WARNING)` to suppress noisy library output (same pattern as test_auth.py). Add a module logger at INFO level for script output.

2. **Pre-flight check**: Call `get_settings().is_mmc_api_key_configured()`. If False, print "MMC API key not configured. Set MMC_API_BASE_URL and MMC_API_KEY in .env" and exit with code 0 (not an error — just not configured yet).

3. **Ensure FactivaConfig exists**: Read FactivaConfig id=1 from database. If not found, run the seed logic inline (insert default row, same as seed_factiva_config.py) rather than requiring a separate script run. Print the active config values.

4. **Build query_params dict** from FactivaConfig fields:
   ```python
   query_params = {
       "industry_codes": config.industry_codes,
       "company_codes": config.company_codes,
       "keywords": config.keywords,
       "page_size": config.page_size,
   }
   ```

5. **Collect articles**: `collector = FactivaCollector()` then `articles = collector.collect(query_params)`. Wrap in try/except to catch and print any API errors with helpful messages.

6. **URL dedup**: Before semantic dedup, remove articles with duplicate source_url values (keep first occurrence). Print count removed.
   ```python
   seen_urls = set()
   url_deduped = []
   for article in articles:
       url = article.get("source_url", "")
       if url and url in seen_urls:
           continue
       if url:
           seen_urls.add(url)
       url_deduped.append(article)
   ```

7. **Semantic dedup**: `deduplicator = ArticleDeduplicator()` then `final_articles = deduplicator.deduplicate(url_deduped)`. Note: First run will download the all-MiniLM-L6-v2 model (~80MB).

8. **Print summary**: For each surviving article, print:
   - Title (first 80 chars)
   - Source name
   - Published at (formatted)
   - Description length (chars)
   - Source URL (first 80 chars)

9. **Print totals**:
   - Articles fetched from Factiva: N
   - After URL dedup: N (removed M)
   - After semantic dedup: N (removed M)
   - Articles with full body (description > 200 chars): N
   - Articles with snippet only (description <= 200 chars): N

10. **Validate required fields**: Check each final article has non-empty title, source_name == "Factiva", and published_at is not None. Print warnings for any missing fields.

11. **Exit code**: 0 on success (even if zero articles found — that's a query tuning issue, not a code error). Non-zero only on unhandled exceptions.

Imports:
- `import logging`, `import sys`
- `from app.config import get_settings`
- `from app.database import SessionLocal`
- `from app.models.factiva_config import FactivaConfig`
- `from app.collectors.factiva import FactivaCollector`
- `from app.services.deduplicator import ArticleDeduplicator`
  </action>
  <verify>
Without MMC credentials: `python scripts/test_factiva.py` prints "not configured" message and exits with code 0.
With MMC credentials (if available): `python scripts/test_factiva.py` fetches articles, deduplicates, and prints summary.
  </verify>
  <done>
scripts/test_factiva.py exists and exercises the full collect -> URL dedup -> semantic dedup -> validate flow, with graceful handling of unconfigured credentials and zero-result queries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run seed script and verify end-to-end</name>
  <files></files>
  <action>
Run the seed script and the test script to validate the full Phase 10 chain:

1. Run `python scripts/seed_factiva_config.py` to ensure FactivaConfig row exists.
2. Run `python scripts/test_factiva.py` — expect either:
   - "not configured" message (if no MMC credentials in .env) — this is the expected case, still validates imports and config reading work
   - Full article output (if MMC credentials are present)
3. Verify no import errors in either script.
4. Verify ApiEvent table has no crash artifacts from the test run.

If credentials ARE configured and fetch succeeds, verify:
- At least 1 article returned (unless Factiva has genuinely zero results for the query)
- Each article has source_name == "Factiva"
- Deduplication stats are printed
  </action>
  <verify>
Both scripts exit with code 0. No Python tracebacks. Import chain `app.collectors.factiva -> app.config -> app.database -> app.models.api_event` resolves cleanly.
  </verify>
  <done>
The full Phase 10 chain is validated: FactivaConfig seeded, FactivaCollector instantiable, ArticleDeduplicator instantiable, test script runs end-to-end without errors.
  </done>
</task>

</tasks>

<verification>
1. `python scripts/seed_factiva_config.py` — exits 0, prints seed confirmation
2. `python scripts/test_factiva.py` — exits 0, prints either "not configured" or article summary
3. `python -c "from app.collectors import FactivaCollector; from app.services.deduplicator import ArticleDeduplicator; print('All Phase 10 imports OK')"` — no errors
4. Check api_events table has no error records from test run (unless credentials are configured and Factiva returned errors)
</verification>

<success_criteria>
- test_factiva.py handles unconfigured state gracefully (exit 0, clear message)
- test_factiva.py exercises full collect -> URL dedup -> semantic dedup -> summary flow
- All Phase 10 imports resolve without errors
- FactivaConfig seeded with Brazilian insurance defaults
- Phase 10 success criteria verifiable through test_factiva.py output
</success_criteria>

<output>
After completion, create `.planning/phases/10-factiva-news-collection/10-03-SUMMARY.md`
</output>
