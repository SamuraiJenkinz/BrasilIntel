---
phase: 08-admin-interface
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app/templates/admin/import.html
  - app/templates/admin/partials/import_preview.html
  - app/routers/admin.py
autonomous: true

must_haves:
  truths:
    - "Import page has drag-and-drop file upload zone"
    - "Clicking upload zone opens file picker"
    - "Preview shows parsed data before commit"
    - "Validation errors display inline before commit allowed"
    - "Commit button imports data and shows success/failure count"
  artifacts:
    - path: "app/templates/admin/import.html"
      provides: "Import page with drag-drop upload"
      contains: "ondrop"
    - path: "app/templates/admin/partials/import_preview.html"
      provides: "Preview table with validation errors"
      contains: "validation"
  key_links:
    - from: "app/templates/admin/import.html"
      to: "app/routers/admin.py"
      via: "hx-post for file upload"
      pattern: "hx-post.*import/preview"
    - from: "app/routers/admin.py"
      to: "app/services/excel_service.py"
      via: "parse_excel for preview"
      pattern: "ExcelService.*parse"
---

<objective>
Build import page with drag-and-drop file upload, preview table, and validation before commit.

Purpose: Enables admin to upload Excel files with preview and validation (ADMN-08, ADMN-09).
Output: Complete import workflow with drag-drop, preview, validation, and commit.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-admin-interface/08-RESEARCH.md
@.planning/phases/08-admin-interface/08-01-SUMMARY.md

# Existing import API to leverage
@app/routers/import_export.py
@app/services/excel_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add import page endpoints to admin router</name>
  <files>app/routers/admin.py</files>
  <action>
1. Add imports:
   - from fastapi import UploadFile, File
   - from app.services.excel_service import ExcelService
   - import uuid

2. Add session storage for import previews (reuse existing pattern):
   ```python
   # In-memory storage for import previews (same as existing import_export router)
   # Key: session_id, Value: {"data": [...], "expires": datetime}
   import_sessions: dict[str, dict] = {}

   def cleanup_expired_sessions():
       """Remove expired preview sessions."""
       now = datetime.now()
       expired = [k for k, v in import_sessions.items() if v["expires"] < now]
       for k in expired:
           del import_sessions[k]
   ```

3. Add import page endpoint:
   ```python
   @router.get("/import", response_class=HTMLResponse, name="admin_import")
   async def admin_import(
       request: Request,
       username: str = Depends(verify_admin)
   ):
       return templates.TemplateResponse(
           "admin/import.html",
           {"request": request, "username": username, "active": "import"}
       )
   ```

4. Add preview endpoint:
   ```python
   @router.post("/import/preview", response_class=HTMLResponse, name="admin_import_preview")
   async def admin_import_preview(
       request: Request,
       file: UploadFile = File(...),
       username: str = Depends(verify_admin)
   ):
       cleanup_expired_sessions()

       # Validate file type
       if not file.filename.endswith(('.xlsx', '.xls')):
           return templates.TemplateResponse(
               "admin/partials/import_preview.html",
               {"request": request, "error": "Please upload an Excel file (.xlsx or .xls)"}
           )

       # Parse Excel file
       try:
           excel_service = ExcelService()
           content = await file.read()
           insurers, errors = excel_service.parse_excel(content, file.filename)
       except Exception as e:
           return templates.TemplateResponse(
               "admin/partials/import_preview.html",
               {"request": request, "error": f"Failed to parse file: {str(e)}"}
           )

       # Store in session for commit
       session_id = str(uuid.uuid4())
       import_sessions[session_id] = {
           "data": insurers,
           "errors": errors,
           "expires": datetime.now() + timedelta(minutes=30)
       }

       return templates.TemplateResponse(
           "admin/partials/import_preview.html",
           {
               "request": request,
               "session_id": session_id,
               "insurers": insurers[:100],  # Preview first 100
               "total": len(insurers),
               "errors": errors,
               "has_errors": len(errors) > 0,
           }
       )
   ```

5. Add commit endpoint:
   ```python
   @router.post("/import/commit", response_class=HTMLResponse, name="admin_import_commit")
   async def admin_import_commit(
       request: Request,
       session_id: str = Form(...),
       mode: str = Form("merge"),  # merge or replace
       username: str = Depends(verify_admin),
       db: Session = Depends(get_db)
   ):
       # Get session data
       session = import_sessions.get(session_id)
       if not session:
           return '<div class="alert alert-danger">Session expired. Please upload again.</div>'

       insurers = session["data"]
       created, updated, skipped = 0, 0, 0

       for data in insurers:
           existing = db.query(Insurer).filter(Insurer.ans_code == data["ans_code"]).first()
           if existing:
               if mode == "merge":
                   for key, value in data.items():
                       setattr(existing, key, value)
                   updated += 1
               else:
                   skipped += 1
           else:
               db.add(Insurer(**data))
               created += 1

       db.commit()

       # Clear session
       del import_sessions[session_id]

       return f'''
       <div class="alert alert-success">
           <strong>Import complete!</strong><br>
           Created: {created}, Updated: {updated}, Skipped: {skipped}
       </div>
       '''
   ```
  </action>
  <verify>
python -c "from app.routers.admin import router; print([r.path for r in router.routes if 'import' in r.path])"
  </verify>
  <done>Admin router has import preview and commit endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Create import page with drag-drop upload</name>
  <files>app/templates/admin/import.html</files>
  <action>
1. Create app/templates/admin/import.html:
   - Extend base.html, title="Import Insurers", active="import"
   - Instructions section explaining file format

2. Drag-and-drop upload form:
   ```html
   <form id="import-form"
         hx-post="{{ url_for('admin_import_preview') }}"
         hx-encoding="multipart/form-data"
         hx-target="#preview-section"
         hx-indicator="#upload-indicator">

       <div id="drop-zone"
            class="border border-2 border-dashed rounded p-5 text-center mb-3"
            style="border-color: #dee2e6; cursor: pointer;"
            ondrop="handleDrop(event)"
            ondragover="handleDragOver(event)"
            ondragleave="handleDragLeave(event)"
            onclick="document.getElementById('file-input').click()">

           <input type="file" name="file" id="file-input"
                  accept=".xlsx,.xls"
                  required
                  class="d-none"
                  onchange="fileSelected(this)">

           <div class="mb-3">
               <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="text-muted" viewBox="0 0 16 16">
                   <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                   <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
               </svg>
           </div>
           <p class="mb-2" id="file-name">Drag Excel file here or click to select</p>
           <small class="text-muted">Accepts .xlsx or .xls files</small>
       </div>

       <button type="submit" class="btn btn-primary" id="preview-btn" disabled>
           <span id="upload-indicator" class="htmx-indicator spinner-border spinner-border-sm me-1"></span>
           Preview Import
       </button>
   </form>
   ```

3. Preview section container:
   ```html
   <div id="preview-section" class="mt-4">
       <!-- HTMX swaps preview content here -->
   </div>
   ```

4. JavaScript for drag-drop handling:
   ```javascript
   function handleDrop(e) {
       e.preventDefault();
       document.getElementById('drop-zone').style.borderColor = '#dee2e6';
       const files = e.dataTransfer.files;
       if (files.length > 0) {
           document.getElementById('file-input').files = files;
           fileSelected(document.getElementById('file-input'));
       }
   }

   function handleDragOver(e) {
       e.preventDefault();
       document.getElementById('drop-zone').style.borderColor = '#0077c8';
   }

   function handleDragLeave(e) {
       document.getElementById('drop-zone').style.borderColor = '#dee2e6';
   }

   function fileSelected(input) {
       const fileName = input.files[0]?.name || 'Drag Excel file here or click to select';
       document.getElementById('file-name').textContent = fileName;
       document.getElementById('preview-btn').disabled = !input.files.length;
       if (input.files.length) {
           document.getElementById('drop-zone').style.borderColor = '#198754';
       }
   }
   ```
  </action>
  <verify>
dir app\templates\admin\import.html
  </verify>
  <done>Import page with drag-drop upload zone created</done>
</task>

<task type="auto">
  <name>Task 3: Create import preview partial with validation</name>
  <files>app/templates/admin/partials/import_preview.html</files>
  <action>
1. Create app/templates/admin/partials/import_preview.html:

2. Error display section:
   ```html
   {% if error %}
   <div class="alert alert-danger">{{ error }}</div>
   {% elif errors %}
   <div class="alert alert-warning">
       <strong>Validation Issues ({{ errors|length }}):</strong>
       <ul class="mb-0 mt-2">
           {% for err in errors[:10] %}
           <li>Row {{ err.row }}: {{ err.message }}</li>
           {% endfor %}
           {% if errors|length > 10 %}
           <li>...and {{ errors|length - 10 }} more</li>
           {% endif %}
       </ul>
   </div>
   {% endif %}
   ```

3. Preview table:
   ```html
   {% if insurers %}
   <div class="card">
       <div class="card-header d-flex justify-content-between align-items-center">
           <span>Preview ({{ insurers|length }}{% if total > 100 %} of {{ total }}{% endif %} insurers)</span>
           <form hx-post="{{ url_for('admin_import_commit') }}"
                 hx-target="#preview-section">
               <input type="hidden" name="session_id" value="{{ session_id }}">
               <div class="btn-group">
                   <select name="mode" class="form-select form-select-sm" style="width: auto;">
                       <option value="merge">Merge (update existing)</option>
                       <option value="skip">Skip existing</option>
                   </select>
                   <button type="submit" class="btn btn-success btn-sm"
                           {% if has_errors %}disabled title="Fix validation errors first"{% endif %}>
                       <span class="htmx-indicator spinner-border spinner-border-sm me-1"></span>
                       Commit Import
                   </button>
               </div>
           </form>
       </div>
       <div class="card-body p-0">
           <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
               <table class="table table-sm table-striped mb-0">
                   <thead class="sticky-top bg-light">
                       <tr>
                           <th>ANS Code</th>
                           <th>Name</th>
                           <th>Category</th>
                           <th>Enabled</th>
                       </tr>
                   </thead>
                   <tbody>
                       {% for ins in insurers %}
                       <tr>
                           <td>{{ ins.ans_code }}</td>
                           <td>{{ ins.name }}</td>
                           <td>{{ ins.category }}</td>
                           <td>
                               {% if ins.enabled %}
                               <span class="badge bg-success">Yes</span>
                               {% else %}
                               <span class="badge bg-secondary">No</span>
                               {% endif %}
                           </td>
                       </tr>
                       {% endfor %}
                   </tbody>
               </table>
           </div>
       </div>
   </div>
   {% endif %}
   ```

4. Note about existing preview limitation:
   - If has_errors is True, disable commit button
   - Show tooltip explaining fix required
  </action>
  <verify>
curl -u admin:changeme http://localhost:8000/admin/import -s | grep -c "drop-zone" (expect 1)
  </verify>
  <done>Import preview partial with validation display and commit button</done>
</task>

</tasks>

<verification>
1. Import page shows drag-and-drop zone - ADMN-08
2. Dragging file over zone highlights border
3. Clicking zone opens file picker
4. Preview shows parsed insurers in table - ADMN-09
5. Validation errors display inline - ADMN-09
6. Commit button disabled when errors exist
7. Successful import shows count of created/updated/skipped
</verification>

<success_criteria>
- ADMN-08 (drag-and-drop file upload) fully met
- ADMN-09 (preview with validation errors) fully met
- File validation rejects non-Excel files
- Preview shows first 100 rows for large files
- Import modes work (merge vs skip existing)
</success_criteria>

<output>
After completion, create `.planning/phases/08-admin-interface/08-04-SUMMARY.md`
</output>
