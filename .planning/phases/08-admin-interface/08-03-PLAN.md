---
phase: 08-admin-interface
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app/templates/admin/insurers.html
  - app/templates/admin/partials/insurer_table.html
  - app/routers/admin.py
autonomous: true

must_haves:
  truths:
    - "Insurers page shows category tabs (All, Health, Dental, Group Life)"
    - "Search box filters insurers by name or ANS code"
    - "Status filter shows enabled/disabled insurers"
    - "Bulk enable/disable buttons work on selected insurers"
    - "Table updates without full page reload via HTMX"
  artifacts:
    - path: "app/templates/admin/insurers.html"
      provides: "Insurers management page"
      contains: "nav-tabs"
    - path: "app/templates/admin/partials/insurer_table.html"
      provides: "HTMX partial for insurer table"
      contains: "checkbox"
  key_links:
    - from: "app/templates/admin/insurers.html"
      to: "app/routers/admin.py"
      via: "hx-get for filtered table"
      pattern: "hx-get.*insurers"
    - from: "app/routers/admin.py"
      to: "app/routers/insurers.py"
      via: "reuses insurer query logic"
      pattern: "Insurer.*filter"
---

<objective>
Build insurers management page with category tabs, search, status filters, and bulk operations.

Purpose: Enables admin to view, search, and manage insurers across all categories (ADMN-06, ADMN-07).
Output: Interactive insurers page with HTMX-powered filtering and bulk actions.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-admin-interface/08-RESEARCH.md
@.planning/phases/08-admin-interface/08-01-SUMMARY.md

# Existing insurer API to leverage
@app/routers/insurers.py
@app/models/insurer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add insurer page endpoints to admin router</name>
  <files>app/routers/admin.py</files>
  <action>
1. Add insurers page endpoint:
   ```python
   @router.get("/insurers", response_class=HTMLResponse, name="admin_insurers")
   async def admin_insurers(
       request: Request,
       category: str | None = None,
       search: str | None = None,
       enabled: str | None = None,  # "true", "false", or None for all
       page: int = 1,
       username: str = Depends(verify_admin),
       db: Session = Depends(get_db)
   ):
       # Query insurers with filters (reuse logic from insurers router)
       q = db.query(Insurer)

       if category:
           q = q.filter(Insurer.category == category)
       if search:
           search_pattern = f"%{search}%"
           q = q.filter(or_(
               Insurer.name.ilike(search_pattern),
               Insurer.ans_code.contains(search)
           ))
       if enabled is not None and enabled != "":
           enabled_bool = enabled.lower() == "true"
           q = q.filter(Insurer.enabled == enabled_bool)

       # Pagination
       per_page = 50
       total = q.count()
       insurers = q.offset((page - 1) * per_page).limit(per_page).all()
       total_pages = (total + per_page - 1) // per_page

       context = {
           "request": request,
           "username": username,
           "active": "insurers",
           "insurers": insurers,
           "category": category,
           "search": search or "",
           "enabled_filter": enabled,
           "page": page,
           "total_pages": total_pages,
           "total": total,
           "categories": ["Health", "Dental", "Group Life"],
       }

       # Return partial for HTMX, full page for direct navigation
       if request.headers.get("HX-Request"):
           return templates.TemplateResponse("admin/partials/insurer_table.html", context)
       return templates.TemplateResponse("admin/insurers.html", context)
   ```

2. Add bulk enable/disable endpoints:
   ```python
   @router.post("/insurers/bulk-enable", response_class=HTMLResponse)
   async def admin_bulk_enable(
       request: Request,
       selected: list[str] = Form(...),  # List of ANS codes
       username: str = Depends(verify_admin),
       db: Session = Depends(get_db)
   ):
       # Update selected insurers
       updated = db.query(Insurer).filter(Insurer.ans_code.in_(selected)).update(
           {"enabled": True}, synchronize_session=False
       )
       db.commit()

       # Return updated table partial with success message
       return f'<div class="alert alert-success">Enabled {updated} insurers</div>'

   @router.post("/insurers/bulk-disable", response_class=HTMLResponse)
   async def admin_bulk_disable(
       request: Request,
       selected: list[str] = Form(...),
       username: str = Depends(verify_admin),
       db: Session = Depends(get_db)
   ):
       updated = db.query(Insurer).filter(Insurer.ans_code.in_(selected)).update(
           {"enabled": False}, synchronize_session=False
       )
       db.commit()
       return f'<div class="alert alert-warning">Disabled {updated} insurers</div>'
   ```

3. Add Form import: from fastapi import Form
  </action>
  <verify>
python -c "from app.routers.admin import router; print([r.path for r in router.routes if 'insurer' in r.path])"
  </verify>
  <done>Admin router has insurer listing and bulk action endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Create insurers page template with filters</name>
  <files>app/templates/admin/insurers.html</files>
  <action>
1. Create app/templates/admin/insurers.html:
   - Extend base.html, title="Insurers", active="insurers"
   - Header row with "Insurers" title and total count badge

2. Category tabs (Bootstrap nav-tabs):
   ```html
   <ul class="nav nav-tabs mb-3" id="category-tabs">
       <li class="nav-item">
           <a class="nav-link {% if not category %}active{% endif %}"
              href="#"
              hx-get="{{ url_for('admin_insurers') }}"
              hx-target="#insurer-list"
              hx-push-url="true">All ({{ total }})</a>
       </li>
       {% for cat in categories %}
       <li class="nav-item">
           <a class="nav-link {% if category == cat %}active{% endif %}"
              href="#"
              hx-get="{{ url_for('admin_insurers') }}?category={{ cat }}"
              hx-target="#insurer-list"
              hx-push-url="true">{{ cat }}</a>
       </li>
       {% endfor %}
   </ul>
   ```

3. Filter row:
   - Search input with hx-get, hx-trigger="keyup changed delay:300ms"
   - Status dropdown (All/Enabled/Disabled) with hx-get on change
   - Both use hx-include to include other filters
   - hx-target="#insurer-list"

4. Bulk action buttons:
   ```html
   <div class="mb-3">
       <button class="btn btn-outline-success btn-sm" id="bulk-enable"
               hx-post="{{ url_for('admin_bulk_enable') }}"
               hx-include="[name='selected']:checked"
               hx-target="#bulk-result"
               disabled>Enable Selected</button>
       <button class="btn btn-outline-warning btn-sm" id="bulk-disable"
               hx-post="{{ url_for('admin_bulk_disable') }}"
               hx-include="[name='selected']:checked"
               hx-target="#bulk-result"
               disabled>Disable Selected</button>
       <span id="bulk-result"></span>
   </div>
   ```

5. Table container:
   ```html
   <div id="insurer-list">
       {% include "admin/partials/insurer_table.html" %}
   </div>
   ```

6. JavaScript for checkbox handling:
   ```javascript
   document.addEventListener('change', function(e) {
       if (e.target.name === 'selected' || e.target.id === 'select-all') {
           const checkboxes = document.querySelectorAll('[name="selected"]:checked');
           document.getElementById('bulk-enable').disabled = checkboxes.length === 0;
           document.getElementById('bulk-disable').disabled = checkboxes.length === 0;
       }
   });
   ```
  </action>
  <verify>
dir app\templates\admin\insurers.html
  </verify>
  <done>Insurers page template with tabs, search, and filters</done>
</task>

<task type="auto">
  <name>Task 3: Create insurer table partial with pagination</name>
  <files>app/templates/admin/partials/insurer_table.html</files>
  <action>
1. Create app/templates/admin/partials/insurer_table.html:
   - Bootstrap table with hover and striped styles

2. Table header with select-all checkbox:
   ```html
   <table class="table table-hover table-striped">
       <thead>
           <tr>
               <th><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
               <th>ANS Code</th>
               <th>Name</th>
               <th>Category</th>
               <th>Status</th>
               <th>Actions</th>
           </tr>
       </thead>
       <tbody>
           {% for insurer in insurers %}
           <tr>
               <td><input type="checkbox" name="selected" value="{{ insurer.ans_code }}"></td>
               <td>{{ insurer.ans_code }}</td>
               <td>{{ insurer.name }}</td>
               <td><span class="badge bg-secondary">{{ insurer.category }}</span></td>
               <td>
                   {% if insurer.enabled %}
                   <span class="badge bg-success">Enabled</span>
                   {% else %}
                   <span class="badge bg-warning">Disabled</span>
                   {% endif %}
               </td>
               <td>
                   <button class="btn btn-sm btn-outline-primary"
                           hx-get="/api/insurers/{{ insurer.ans_code }}"
                           hx-target="#modal-body"
                           data-bs-toggle="modal"
                           data-bs-target="#insurer-modal">View</button>
               </td>
           </tr>
           {% else %}
           <tr>
               <td colspan="6" class="text-center text-muted">No insurers found</td>
           </tr>
           {% endfor %}
       </tbody>
   </table>
   ```

3. Pagination controls:
   ```html
   {% if total_pages > 1 %}
   <nav>
       <ul class="pagination justify-content-center">
           <li class="page-item {% if page <= 1 %}disabled{% endif %}">
               <a class="page-link"
                  hx-get="{{ url_for('admin_insurers') }}?page={{ page - 1 }}&category={{ category or '' }}&search={{ search }}&enabled={{ enabled_filter or '' }}"
                  hx-target="#insurer-list">Previous</a>
           </li>
           <li class="page-item active">
               <span class="page-link">Page {{ page }} of {{ total_pages }}</span>
           </li>
           <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
               <a class="page-link"
                  hx-get="{{ url_for('admin_insurers') }}?page={{ page + 1 }}&category={{ category or '' }}&search={{ search }}&enabled={{ enabled_filter or '' }}"
                  hx-target="#insurer-list">Next</a>
           </li>
       </ul>
   </nav>
   {% endif %}
   ```

4. Add toggleAll JavaScript function to base template or insurers page:
   ```javascript
   function toggleAll(source) {
       const checkboxes = document.querySelectorAll('[name="selected"]');
       checkboxes.forEach(cb => cb.checked = source.checked);
       // Trigger change event for button state update
       document.dispatchEvent(new Event('change', { bubbles: true }));
   }
   ```
  </action>
  <verify>
curl -u admin:changeme http://localhost:8000/admin/insurers -s | grep -c "checkbox" (expect multiple)
curl -u admin:changeme "http://localhost:8000/admin/insurers?category=Health" -s | grep -c "Health" (expect matches)
  </verify>
  <done>Insurer table partial with checkboxes and pagination</done>
</task>

</tasks>

<verification>
1. Insurers page shows category tabs (All, Health, Dental, Group Life) - ADMN-06
2. Clicking tab filters table without full page reload
3. Search box filters by name or ANS code with 300ms debounce - ADMN-06
4. Status filter shows only enabled or disabled insurers - ADMN-06
5. Checkbox selection enables bulk action buttons - ADMN-07
6. Bulk enable/disable updates selected insurers - ADMN-07
7. Pagination works for large insurer lists
</verification>

<success_criteria>
- ADMN-06 (category tabs, search, status filters) fully met
- ADMN-07 (bulk enable/disable operations) fully met
- Table loads 50 insurers per page
- All filters work together (category + search + status)
- HTMX partial updates maintain filter state
</success_criteria>

<output>
After completion, create `.planning/phases/08-admin-interface/08-03-SUMMARY.md`
</output>
