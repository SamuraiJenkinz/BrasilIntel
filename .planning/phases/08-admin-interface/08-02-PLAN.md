---
phase: 08-admin-interface
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app/templates/admin/dashboard.html
  - app/templates/admin/partials/category_card.html
  - app/templates/admin/partials/recent_reports.html
  - app/routers/admin.py
autonomous: true

must_haves:
  truths:
    - "Dashboard shows summary card for each category (Health, Dental, Group Life)"
    - "Each card displays insurer count, last run time, next run time"
    - "Dashboard shows system status indicator (healthy/warning/error)"
    - "Dashboard shows recent reports list with links to view"
  artifacts:
    - path: "app/templates/admin/dashboard.html"
      provides: "Full dashboard page with summary cards"
      contains: "hx-get"
    - path: "app/templates/admin/partials/category_card.html"
      provides: "HTMX partial for category status card"
      contains: "card-body"
    - path: "app/templates/admin/partials/recent_reports.html"
      provides: "HTMX partial for recent reports list"
      contains: "list-group"
  key_links:
    - from: "app/templates/admin/dashboard.html"
      to: "app/routers/admin.py"
      via: "hx-get for card refresh"
      pattern: "hx-get.*dashboard/card"
    - from: "app/routers/admin.py"
      to: "app/services/scheduler_service.py"
      via: "get_schedule() for next run"
      pattern: "SchedulerService.*get_schedule"
---

<objective>
Build dashboard page with category summary cards, system status, and recent reports list.

Purpose: Provides at-a-glance status for all categories and quick access to recent reports (ADMN-03, ADMN-04, ADMN-05).
Output: Fully functional dashboard with HTMX-powered auto-refreshing cards.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-admin-interface/08-RESEARCH.md
@.planning/phases/08-admin-interface/08-01-SUMMARY.md

# Existing APIs to leverage
@app/routers/schedules.py
@app/services/scheduler_service.py
@app/services/report_archiver.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dashboard data endpoints to admin router</name>
  <files>app/routers/admin.py</files>
  <action>
1. Add imports to admin router:
   - from app.models.insurer import Insurer
   - from app.models.run import Run
   - from app.services.scheduler_service import SchedulerService
   - from app.services.report_archiver import ReportArchiver
   - from sqlalchemy import func
   - from datetime import datetime

2. Create helper function get_category_stats(db, category):
   - Query Insurer count for category
   - Query latest Run for category (order by created_at desc, limit 1)
   - Get schedule info from SchedulerService().get_schedule(category)
   - Return dict with: insurer_count, last_run (time + status), next_run, enabled

3. Create helper function get_system_health():
   - Check database connectivity (already done in /api/health)
   - Check scheduler status (SchedulerService running)
   - Check external services (settings.is_azure_openai_configured(), etc.)
   - Return status: "healthy", "warning", or "error"

4. Create helper function get_recent_reports(limit=5):
   - Use ReportArchiver.list_reports() to get recent reports
   - Return list with: date, category, filename, view_url

5. Update dashboard endpoint to gather all data:
   - Get stats for each category: Health, Dental, Group Life
   - Get system health status
   - Get recent reports
   - Pass all to template

6. Create HTMX partial endpoints:
   - GET /admin/dashboard/card/{category} - returns category card partial (for refresh)
   - GET /admin/dashboard/reports - returns recent reports partial (for refresh)
   - Check HX-Request header to return partial vs full page
  </action>
  <verify>
python -c "from app.routers.admin import router; routes = [r.path for r in router.routes]; print('card' in str(routes))"
  </verify>
  <done>Admin router has dashboard data endpoints and helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard template with summary cards</name>
  <files>app/templates/admin/dashboard.html, app/templates/admin/partials/category_card.html</files>
  <action>
1. Create app/templates/admin/partials/ directory

2. Create app/templates/admin/partials/category_card.html:
   - Bootstrap card component
   - Card header with category name and enable/disable badge
   - Card body with:
     - Insurer count: "N insurers"
     - Last run: datetime + status badge (completed/failed/running)
     - Next run: datetime or "Paused" if disabled
   - Card footer with "Run Now" button (hx-post to trigger)
   - Use status_color filter: completed=success, failed=danger, running=primary
   - Add hx-swap-oob for partial updates

3. Update app/templates/admin/dashboard.html:
   - Extend base.html, set title="Dashboard", active="dashboard"
   - Row of 3 category cards using Bootstrap grid (col-md-4)
   - Each card uses hx-get="/admin/dashboard/card/{category}" hx-trigger="load, every 60s"
   - System status section:
     - Health indicator with colored badge (healthy=green, warning=yellow, error=red)
     - Show key service statuses (Database, Scheduler, Azure OpenAI, Graph Email)
   - Recent reports section:
     - List group with 5 most recent reports
     - Each item shows: date, category, "View" link
     - Use hx-get="/admin/dashboard/reports" hx-trigger="load, every 300s" for refresh

4. Add Jinja2 filters to admin router (or use template globals):
   - format_datetime: format datetime for display
   - timeago: relative time display (e.g., "2 hours ago")
   - status_color: map status to Bootstrap color class
  </action>
  <verify>
Check templates exist:
dir app\templates\admin\dashboard.html
dir app\templates\admin\partials\category_card.html
  </verify>
  <done>Dashboard template with category cards and system status section</done>
</task>

<task type="auto">
  <name>Task 3: Create recent reports partial and test dashboard</name>
  <files>app/templates/admin/partials/recent_reports.html, app/routers/admin.py</files>
  <action>
1. Create app/templates/admin/partials/recent_reports.html:
   - Bootstrap list-group component
   - Each item shows: date badge, category text, "View" link
   - Link href to /api/reports/archive/{date}/{filename}
   - Show "No reports yet" message if list empty

2. Add Jinja2 template filters to admin router:
   ```python
   from datetime import datetime, timedelta

   def format_datetime(value):
       if not value:
           return "Never"
       if isinstance(value, str):
           value = datetime.fromisoformat(value)
       return value.strftime("%d/%m/%Y %H:%M")

   def timeago(value):
       if not value:
           return "Never"
       if isinstance(value, str):
           value = datetime.fromisoformat(value)
       delta = datetime.now() - value
       if delta < timedelta(minutes=1):
           return "Just now"
       elif delta < timedelta(hours=1):
           return f"{int(delta.seconds / 60)} min ago"
       elif delta < timedelta(days=1):
           return f"{int(delta.seconds / 3600)} hours ago"
       else:
           return f"{delta.days} days ago"

   def status_color(status):
       colors = {
           "completed": "success",
           "failed": "danger",
           "running": "primary",
           "pending": "secondary",
           "healthy": "success",
           "warning": "warning",
           "error": "danger",
       }
       return colors.get(str(status).lower(), "secondary")

   # Register filters with templates
   templates.env.filters["format_datetime"] = format_datetime
   templates.env.filters["timeago"] = timeago
   templates.env.filters["status_color"] = status_color
   ```

3. Test dashboard functionality:
   - Start server
   - Visit /admin/dashboard with credentials
   - Verify 3 category cards display
   - Verify system status shows
   - Verify recent reports section shows (may be empty if no reports yet)
   - Check browser dev tools that HTMX requests fire on interval
  </action>
  <verify>
curl -u admin:changeme http://localhost:8000/admin/dashboard -s | grep -c "card-body" (expect 3 or more)
curl -u admin:changeme http://localhost:8000/admin/dashboard/card/Health -s | grep -c "Insurers" (expect 1)
  </verify>
  <done>Dashboard fully functional with category cards, status, and recent reports</done>
</task>

</tasks>

<verification>
1. Dashboard shows 3 category cards (Health, Dental, Group Life) - ADMN-03
2. Each card shows insurer count, last run time with status, next run time
3. System status section shows healthy/warning/error indicator - ADMN-05
4. Recent reports list shows with view links - ADMN-04
5. Cards auto-refresh via HTMX every 60 seconds
6. "Run Now" button present on each card (triggers in 08-05)
</verification>

<success_criteria>
- ADMN-03 (summary cards per category) fully met
- ADMN-04 (recent reports with links) fully met
- ADMN-05 (system status indicators) fully met
- Dashboard loads in under 2 seconds
- HTMX partial updates work without full page reload
</success_criteria>

<output>
After completion, create `.planning/phases/08-admin-interface/08-02-SUMMARY.md`
</output>
