---
phase: 08-admin-interface
plan: 05
type: execute
wave: 3
depends_on: ["08-01"]
files_modified:
  - app/templates/admin/recipients.html
  - app/templates/admin/schedules.html
  - app/templates/admin/partials/schedule_card.html
  - app/routers/admin.py
autonomous: true

must_haves:
  truths:
    - "Recipients page shows current recipients per category (TO/CC/BCC)"
    - "Schedules page shows card for each category with cron, next run, toggle"
    - "Enable/disable toggle updates schedule without page reload"
    - "Manual trigger button initiates run and shows feedback"
    - "Next run time updates after schedule change"
  artifacts:
    - path: "app/templates/admin/recipients.html"
      provides: "Recipients management page"
      contains: "recipient"
    - path: "app/templates/admin/schedules.html"
      provides: "Schedules management page"
      contains: "schedule"
    - path: "app/templates/admin/partials/schedule_card.html"
      provides: "Schedule card partial for HTMX updates"
      contains: "form-switch"
  key_links:
    - from: "app/templates/admin/schedules.html"
      to: "app/routers/admin.py"
      via: "hx-post for toggle and trigger"
      pattern: "hx-post.*schedule"
    - from: "app/routers/admin.py"
      to: "app/services/scheduler_service.py"
      via: "pause_job/resume_job/trigger_now"
      pattern: "SchedulerService.*pause|resume|trigger"
---

<objective>
Build recipients display page and schedules management page with toggle and manual trigger controls.

Purpose: Enables viewing recipients and managing schedule configurations (ADMN-10, ADMN-11, ADMN-12, ADMN-13).
Output: Recipients page showing current config, schedules page with full control.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-admin-interface/08-RESEARCH.md
@.planning/phases/08-admin-interface/08-01-SUMMARY.md

# Existing APIs to leverage
@app/routers/schedules.py
@app/services/scheduler_service.py
@app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add recipients and schedules page endpoints</name>
  <files>app/routers/admin.py</files>
  <action>
1. Add recipients page endpoint:
   ```python
   @router.get("/recipients", response_class=HTMLResponse, name="admin_recipients")
   async def admin_recipients(
       request: Request,
       username: str = Depends(verify_admin),
       settings: Settings = Depends(get_settings)
   ):
       # Build recipients data from settings
       categories = ["Health", "Dental", "Group Life"]
       recipients_data = {}

       for cat in categories:
           email_recipients = settings.get_email_recipients(cat)
           recipients_data[cat] = {
               "to": email_recipients.to,
               "cc": email_recipients.cc,
               "bcc": email_recipients.bcc,
               "has_recipients": email_recipients.has_recipients,
           }

       return templates.TemplateResponse(
           "admin/recipients.html",
           {
               "request": request,
               "username": username,
               "active": "recipients",
               "categories": categories,
               "recipients": recipients_data,
           }
       )
   ```

2. Add schedules page endpoint:
   ```python
   @router.get("/schedules", response_class=HTMLResponse, name="admin_schedules")
   async def admin_schedules(
       request: Request,
       username: str = Depends(verify_admin),
       db: Session = Depends(get_db)
   ):
       scheduler = SchedulerService()
       categories = ["Health", "Dental", "Group Life"]
       schedules_data = []

       for cat in categories:
           schedule_info = scheduler.get_schedule(cat)
           # Get latest run for this category
           latest_run = db.query(Run).filter(
               Run.category == cat
           ).order_by(Run.created_at.desc()).first()

           schedules_data.append({
               "category": cat,
               "cron_expression": schedule_info.get("cron", "Not configured"),
               "enabled": schedule_info.get("enabled", False),
               "next_run_time": schedule_info.get("next_run_time"),
               "last_run": latest_run,
           })

       return templates.TemplateResponse(
           "admin/schedules.html",
           {
               "request": request,
               "username": username,
               "active": "schedules",
               "schedules": schedules_data,
           }
       )
   ```

3. Add schedule toggle endpoint:
   ```python
   @router.post("/schedules/{category}/toggle", response_class=HTMLResponse, name="admin_toggle_schedule")
   async def admin_toggle_schedule(
       request: Request,
       category: str,
       enabled: bool = Form(...),
       username: str = Depends(verify_admin),
       db: Session = Depends(get_db)
   ):
       scheduler = SchedulerService()

       if enabled:
           scheduler.resume_job(category)
       else:
           scheduler.pause_job(category)

       # Get updated schedule info
       schedule_info = scheduler.get_schedule(category)
       latest_run = db.query(Run).filter(
           Run.category == category
       ).order_by(Run.created_at.desc()).first()

       return templates.TemplateResponse(
           "admin/partials/schedule_card.html",
           {
               "request": request,
               "schedule": {
                   "category": category,
                   "cron_expression": schedule_info.get("cron", "Not configured"),
                   "enabled": schedule_info.get("enabled", False),
                   "next_run_time": schedule_info.get("next_run_time"),
                   "last_run": latest_run,
               },
               "index": category.lower().replace(" ", "-"),
           }
       )
   ```

4. Add manual trigger endpoint:
   ```python
   @router.post("/schedules/{category}/trigger", response_class=HTMLResponse, name="admin_trigger_run")
   async def admin_trigger_run(
       request: Request,
       category: str,
       username: str = Depends(verify_admin)
   ):
       scheduler = SchedulerService()

       try:
           run_id = await scheduler.trigger_now(category)
           return f'<span class="text-success">Run #{run_id} started</span>'
       except Exception as e:
           return f'<span class="text-danger">Error: {str(e)}</span>'
   ```
  </action>
  <verify>
python -c "from app.routers.admin import router; paths = [r.path for r in router.routes]; print('recipients' in str(paths) and 'schedules' in str(paths))"
  </verify>
  <done>Admin router has recipients and schedules endpoints with toggle/trigger</done>
</task>

<task type="auto">
  <name>Task 2: Create recipients page template</name>
  <files>app/templates/admin/recipients.html</files>
  <action>
1. Create app/templates/admin/recipients.html:
   - Extend base.html, title="Recipients", active="recipients"
   - Header explaining recipients are configured via environment variables

2. Recipients display by category:
   ```html
   <div class="alert alert-info mb-4">
       <strong>Note:</strong> Recipients are configured via environment variables.
       Edit your <code>.env</code> file to modify recipient lists.
   </div>

   {% for cat in categories %}
   <div class="card mb-3">
       <div class="card-header d-flex justify-content-between align-items-center">
           <h5 class="mb-0">{{ cat }}</h5>
           {% if recipients[cat].has_recipients %}
           <span class="badge bg-success">Configured</span>
           {% else %}
           <span class="badge bg-warning">Not configured</span>
           {% endif %}
       </div>
       <div class="card-body">
           <div class="row">
               <div class="col-md-4">
                   <h6>TO</h6>
                   {% if recipients[cat].to %}
                   <ul class="list-unstyled">
                       {% for email in recipients[cat].to %}
                       <li><code>{{ email }}</code></li>
                       {% endfor %}
                   </ul>
                   {% else %}
                   <p class="text-muted mb-0">None configured</p>
                   {% endif %}
               </div>
               <div class="col-md-4">
                   <h6>CC</h6>
                   {% if recipients[cat].cc %}
                   <ul class="list-unstyled">
                       {% for email in recipients[cat].cc %}
                       <li><code>{{ email }}</code></li>
                       {% endfor %}
                   </ul>
                   {% else %}
                   <p class="text-muted mb-0">None configured</p>
                   {% endif %}
               </div>
               <div class="col-md-4">
                   <h6>BCC</h6>
                   {% if recipients[cat].bcc %}
                   <ul class="list-unstyled">
                       {% for email in recipients[cat].bcc %}
                       <li><code>{{ email }}</code></li>
                       {% endfor %}
                   </ul>
                   {% else %}
                   <p class="text-muted mb-0">None configured</p>
                   {% endif %}
               </div>
           </div>
       </div>
   </div>
   {% endfor %}
   ```

3. Environment variable reference section:
   ```html
   <div class="card">
       <div class="card-header">Environment Variable Reference</div>
       <div class="card-body">
           <table class="table table-sm">
               <thead>
                   <tr>
                       <th>Category</th>
                       <th>TO Variable</th>
                       <th>CC Variable</th>
                       <th>BCC Variable</th>
                   </tr>
               </thead>
               <tbody>
                   <tr>
                       <td>Health</td>
                       <td><code>REPORT_RECIPIENTS_HEALTH</code></td>
                       <td><code>REPORT_RECIPIENTS_HEALTH_CC</code></td>
                       <td><code>REPORT_RECIPIENTS_HEALTH_BCC</code></td>
                   </tr>
                   <tr>
                       <td>Dental</td>
                       <td><code>REPORT_RECIPIENTS_DENTAL</code></td>
                       <td><code>REPORT_RECIPIENTS_DENTAL_CC</code></td>
                       <td><code>REPORT_RECIPIENTS_DENTAL_BCC</code></td>
                   </tr>
                   <tr>
                       <td>Group Life</td>
                       <td><code>REPORT_RECIPIENTS_GROUP_LIFE</code></td>
                       <td><code>REPORT_RECIPIENTS_GROUP_LIFE_CC</code></td>
                       <td><code>REPORT_RECIPIENTS_GROUP_LIFE_BCC</code></td>
                   </tr>
               </tbody>
           </table>
           <small class="text-muted">Use comma-separated email addresses. Example: <code>user1@example.com, user2@example.com</code></small>
       </div>
   </div>
   ```
  </action>
  <verify>
dir app\templates\admin\recipients.html
  </verify>
  <done>Recipients page showing current configuration per category</done>
</task>

<task type="auto">
  <name>Task 3: Create schedules page with toggle and trigger</name>
  <files>app/templates/admin/schedules.html, app/templates/admin/partials/schedule_card.html</files>
  <action>
1. Create app/templates/admin/partials/schedule_card.html:
   ```html
   <div class="card" id="schedule-{{ index }}">
       <div class="card-header d-flex justify-content-between align-items-center">
           <h5 class="mb-0">{{ schedule.category }}</h5>
           <div class="form-check form-switch">
               <input class="form-check-input" type="checkbox" role="switch"
                      id="toggle-{{ index }}"
                      {% if schedule.enabled %}checked{% endif %}
                      hx-post="{{ url_for('admin_toggle_schedule', category=schedule.category) }}"
                      hx-vals='{"enabled": {{ "false" if schedule.enabled else "true" }}}'
                      hx-target="#schedule-{{ index }}"
                      hx-swap="outerHTML">
               <label class="form-check-label" for="toggle-{{ index }}">
                   {% if schedule.enabled %}Enabled{% else %}Paused{% endif %}
               </label>
           </div>
       </div>
       <div class="card-body">
           <dl class="row mb-0">
               <dt class="col-4">Cron:</dt>
               <dd class="col-8"><code>{{ schedule.cron_expression }}</code></dd>

               <dt class="col-4">Next Run:</dt>
               <dd class="col-8">
                   {% if schedule.enabled and schedule.next_run_time %}
                   {{ schedule.next_run_time|format_datetime }}
                   {% elif not schedule.enabled %}
                   <span class="text-muted">Paused</span>
                   {% else %}
                   <span class="text-muted">Not scheduled</span>
                   {% endif %}
               </dd>

               <dt class="col-4">Last Run:</dt>
               <dd class="col-8">
                   {% if schedule.last_run %}
                   {{ schedule.last_run.created_at|format_datetime }}
                   <span class="badge bg-{{ schedule.last_run.status|status_color }}">
                       {{ schedule.last_run.status }}
                   </span>
                   {% else %}
                   <span class="text-muted">Never</span>
                   {% endif %}
               </dd>
           </dl>
       </div>
       <div class="card-footer">
           <button class="btn btn-sm btn-primary"
                   hx-post="{{ url_for('admin_trigger_run', category=schedule.category) }}"
                   hx-indicator="#trigger-spinner-{{ index }}"
                   hx-target="#trigger-result-{{ index }}"
                   hx-swap="innerHTML">
               <span id="trigger-spinner-{{ index }}"
                     class="htmx-indicator spinner-border spinner-border-sm me-1"></span>
               Run Now
           </button>
           <span id="trigger-result-{{ index }}" class="ms-2"></span>
       </div>
   </div>
   ```

2. Create app/templates/admin/schedules.html:
   ```html
   {% extends "admin/base.html" %}
   {% block title %}Schedules{% endblock %}

   {% block content %}
   <h2>Schedules</h2>
   <p class="text-muted">Manage automated report generation schedules.</p>

   <div class="row" id="schedule-cards">
       {% for schedule in schedules %}
       <div class="col-md-4 mb-3">
           {% set index = schedule.category|lower|replace(" ", "-") %}
           {% include "admin/partials/schedule_card.html" %}
       </div>
       {% endfor %}
   </div>

   <div class="card mt-4">
       <div class="card-header">Cron Expression Reference</div>
       <div class="card-body">
           <p class="mb-2">Cron expressions: <code>minute hour day-of-month month day-of-week</code></p>
           <table class="table table-sm">
               <thead>
                   <tr><th>Expression</th><th>Meaning</th></tr>
               </thead>
               <tbody>
                   <tr><td><code>0 6 * * *</code></td><td>Daily at 6:00 AM</td></tr>
                   <tr><td><code>0 7 * * 1-5</code></td><td>Weekdays at 7:00 AM</td></tr>
                   <tr><td><code>0 8 * * 1</code></td><td>Mondays at 8:00 AM</td></tr>
               </tbody>
           </table>
           <small class="text-muted">
               Modify schedules via environment variables:
               <code>SCHEDULE_HEALTH_CRON</code>, <code>SCHEDULE_DENTAL_CRON</code>, <code>SCHEDULE_GROUP_LIFE_CRON</code>
           </small>
       </div>
   </div>
   {% endblock %}
   ```
  </action>
  <verify>
curl -u admin:changeme http://localhost:8000/admin/schedules -s | grep -c "form-switch" (expect 3)
  </verify>
  <done>Schedules page with toggle controls and manual trigger buttons</done>
</task>

</tasks>

<verification>
1. Recipients page shows TO/CC/BCC lists per category - ADMN-10
2. Recipients page shows env var reference for editing - ADMN-11 partial (read-only)
3. Schedules page shows card for each category - ADMN-12
4. Each card shows cron expression and next run time - ADMN-12
5. Enable/disable toggle updates via HTMX without reload - ADMN-12
6. Manual trigger button starts run and shows feedback - ADMN-13
7. Next run time shows "Paused" when disabled
</verification>

<success_criteria>
- ADMN-10 (recipients with subscriptions) partially met (read-only display)
- ADMN-11 (add/edit/remove) partially met (env var reference provided)
- ADMN-12 (schedules with cron, next run, toggle) fully met
- ADMN-13 (manual trigger button) fully met
- Toggle updates schedule state without page reload
- Manual trigger provides immediate feedback
</success_criteria>

<output>
After completion, create `.planning/phases/08-admin-interface/08-05-SUMMARY.md`
</output>
