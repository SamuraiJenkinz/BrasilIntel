---
phase: 08-admin-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/dependencies.py
  - app/config.py
  - app/routers/admin.py
  - app/templates/admin/base.html
  - app/main.py
autonomous: true

must_haves:
  truths:
    - "Admin pages require HTTP Basic authentication"
    - "Browser prompts for username/password on first admin access"
    - "Invalid credentials receive 401 Unauthorized"
    - "Base template renders with Marsh branding and sidebar navigation"
  artifacts:
    - path: "app/dependencies.py"
      provides: "verify_admin auth dependency"
      contains: "HTTPBasic"
    - path: "app/config.py"
      provides: "admin_username and admin_password settings"
      contains: "admin_username"
    - path: "app/routers/admin.py"
      provides: "Admin UI router with auth protection"
      exports: ["router"]
    - path: "app/templates/admin/base.html"
      provides: "Base admin template with nav and auth"
      contains: "BrasilIntel Admin"
  key_links:
    - from: "app/routers/admin.py"
      to: "app/dependencies.py"
      via: "Depends(verify_admin)"
      pattern: "Depends\\(verify_admin\\)"
    - from: "app/main.py"
      to: "app/routers/admin.py"
      via: "include_router"
      pattern: "include_router.*admin"
---

<objective>
Set up admin interface foundation with HTTP Basic authentication, base Jinja2 template, and router scaffolding.

Purpose: Provides secure entry point for all admin pages with consistent layout and authentication (ADMN-01, ADMN-02).
Output: Working /admin route with login prompt and base template rendering.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-admin-interface/08-RESEARCH.md

# Existing patterns
@app/main.py
@app/config.py
@app/dependencies.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add admin auth settings and verify_admin dependency</name>
  <files>app/config.py, app/dependencies.py</files>
  <action>
1. In app/config.py, add to Settings class:
   - admin_username: str = "admin" (default for development)
   - admin_password: str = "" (empty forces user to set via env)
   - admin_port: int = 3000 (ADMN-01 default port, though FastAPI uses single port)

2. In app/dependencies.py, add HTTP Basic auth dependency:
   - Import: secrets, HTTPBasic, HTTPBasicCredentials from fastapi.security
   - Import: Annotated from typing
   - Import: get_settings from app.config
   - Create security = HTTPBasic() instance
   - Create verify_admin(credentials, settings) function:
     - Get admin_username/admin_password from settings
     - Use secrets.compare_digest() for constant-time comparison
     - Raise HTTPException 401 with WWW-Authenticate: Basic header on failure
     - Return username on success

Pattern from research:
```python
def verify_admin(
    credentials: Annotated[HTTPBasicCredentials, Depends(security)],
    settings: Annotated[Settings, Depends(get_settings)]
) -> str:
    expected_user = (settings.admin_username or "admin").encode("utf-8")
    expected_pass = (settings.admin_password or "changeme").encode("utf-8")

    user_ok = secrets.compare_digest(credentials.username.encode("utf-8"), expected_user)
    pass_ok = secrets.compare_digest(credentials.password.encode("utf-8"), expected_pass)

    if not (user_ok and pass_ok):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid credentials",
            headers={"WWW-Authenticate": "Basic realm='BrasilIntel Admin'"},
        )
    return credentials.username
```
  </action>
  <verify>
Run: python -c "from app.dependencies import verify_admin; print('OK')"
Run: python -c "from app.config import get_settings; s = get_settings(); print(f'admin_username={s.admin_username}')"
  </verify>
  <done>verify_admin dependency importable and settings include admin_username/admin_password</done>
</task>

<task type="auto">
  <name>Task 2: Create admin router with base template</name>
  <files>app/routers/admin.py, app/templates/admin/base.html</files>
  <action>
1. Create app/templates/admin/ directory

2. Create app/templates/admin/base.html:
   - HTML5 doctype with lang="pt-BR"
   - Bootstrap 5.3.3 CSS via CDN
   - HTMX 2.0.4 via CDN
   - Bootstrap 5.3.3 JS bundle via CDN
   - Custom CSS variables for Marsh colors (--marsh-blue: #00263e, --marsh-light-blue: #0077c8)
   - Navbar with "BrasilIntel Admin" brand and logged-in username display
   - Sidebar with nav links: Dashboard, Insurers, Import, Recipients, Schedules, Settings
   - Use url_for() for nav links (name routes in router)
   - Active state highlighting via {% if active == 'dashboard' %}active{% endif %}
   - Main content area with {% block content %}{% endblock %}
   - HTMX indicator CSS: .htmx-indicator { display: none; } .htmx-request .htmx-indicator { display: inline-block; }

3. Create app/routers/admin.py:
   - Import: APIRouter, Depends, Request from fastapi
   - Import: HTMLResponse from fastapi.responses
   - Import: Jinja2Templates from fastapi.templating
   - Import: verify_admin, get_db from app.dependencies
   - Import: Settings, get_settings from app.config
   - Create router = APIRouter(prefix="/admin", tags=["Admin"])
   - Create templates = Jinja2Templates(directory="app/templates")
   - Create dashboard endpoint at "/" and "/dashboard" (both map to same handler)
   - Name the route "admin_dashboard" for url_for
   - Use response_class=HTMLResponse
   - Add username: str = Depends(verify_admin) for auth
   - Return templates.TemplateResponse with request, username, active="dashboard"
   - For now, dashboard.html can extend base and show "Dashboard content coming soon"

4. Create minimal app/templates/admin/dashboard.html:
   - {% extends "admin/base.html" %}
   - {% block title %}Dashboard{% endblock %}
   - {% block content %}<h2>Dashboard</h2><p>Coming in 08-02</p>{% endblock %}
  </action>
  <verify>
Check file exists: dir app\templates\admin\base.html
Check router exists: python -c "from app.routers.admin import router; print(f'prefix={router.prefix}')"
  </verify>
  <done>Admin router created with base template, dashboard placeholder renders</done>
</task>

<task type="auto">
  <name>Task 3: Register admin router in main.py and test</name>
  <files>app/main.py</files>
  <action>
1. In app/main.py:
   - Add import: from app.routers import admin
   - Add after existing router registrations: app.include_router(admin.router)
   - No prefix needed (router already has /admin prefix)

2. Test the admin interface:
   - Start server: uvicorn app.main:app --reload
   - Visit http://localhost:8000/admin
   - Browser should prompt for Basic Auth credentials
   - With correct credentials (admin/changeme or from env), should see dashboard page
   - With wrong credentials, should see 401 error
  </action>
  <verify>
Start server and test:
curl -u admin:changeme http://localhost:8000/admin -o /dev/null -w "%{http_code}" (expect 200)
curl http://localhost:8000/admin -o /dev/null -w "%{http_code}" (expect 401)
  </verify>
  <done>Admin interface accessible at /admin with Basic Auth protection</done>
</task>

</tasks>

<verification>
1. Navigate to http://localhost:8000/admin - browser prompts for credentials (ADMN-02)
2. Enter valid credentials - see dashboard page with Marsh branding
3. Enter invalid credentials - receive 401 Unauthorized
4. Sidebar navigation links present (Dashboard, Insurers, Import, Recipients, Schedules, Settings)
5. Base template includes Bootstrap 5 and HTMX CDN links
</verification>

<success_criteria>
- HTTP Basic Auth protects all /admin/* routes
- Browser shows native login prompt on first access
- Dashboard page renders with Marsh blue navbar
- Sidebar shows all navigation items
- ADMN-01 (web dashboard accessible) partially met
- ADMN-02 (basic authentication) fully met
</success_criteria>

<output>
After completion, create `.planning/phases/08-admin-interface/08-01-SUMMARY.md`
</output>
