---
phase: 08-admin-interface
plan: 06
type: execute
wave: 3
depends_on: ["08-01"]
files_modified:
  - app/templates/admin/settings.html
  - app/routers/admin.py
autonomous: false

must_haves:
  truths:
    - "Settings page shows company branding section (name, classification level)"
    - "Settings page shows scraping config (batch size, timeout, lookback days)"
    - "API keys displayed masked with asterisks by default"
    - "Reveal toggle shows/hides API key values"
    - "Settings display current configuration values"
  artifacts:
    - path: "app/templates/admin/settings.html"
      provides: "Settings page with masked API keys"
      contains: "type=\"password\""
  key_links:
    - from: "app/templates/admin/settings.html"
      to: "app/routers/admin.py"
      via: "settings data passed to template"
      pattern: "settings.*company_name"
---

<objective>
Build settings page showing company branding, scraping config, and masked API keys with reveal toggle.

Purpose: Provides visibility into system configuration with secure API key display (ADMN-14, ADMN-15, ADMN-16).
Output: Complete settings page with read-only display and secure key masking.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-admin-interface/08-RESEARCH.md
@.planning/phases/08-admin-interface/08-01-SUMMARY.md

# Existing configuration
@app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add settings page endpoint</name>
  <files>app/routers/admin.py</files>
  <action>
1. Add helper function to mask API keys:
   ```python
   def mask_key(value: str, show_chars: int = 4) -> str:
       """Mask API key showing only last N characters."""
       if not value:
           return "(not configured)"
       if len(value) <= show_chars:
           return "*" * len(value)
       return "*" * (len(value) - show_chars) + value[-show_chars:]
   ```

2. Add settings page endpoint:
   ```python
   @router.get("/settings", response_class=HTMLResponse, name="admin_settings")
   async def admin_settings(
       request: Request,
       username: str = Depends(verify_admin),
       settings: Settings = Depends(get_settings)
   ):
       # Company branding settings
       branding = {
           "company_name": settings.company_name,
           "classification_level": "CONFIDENTIAL",  # Could be added to Settings
       }

       # Scraping configuration
       scraping_config = {
           "batch_size": settings.batch_size,
           "batch_delay_seconds": settings.batch_delay_seconds,
           "max_concurrent_sources": settings.max_concurrent_sources,
           "scrape_timeout_seconds": settings.scrape_timeout_seconds,
           "scrape_max_results": settings.scrape_max_results,
       }

       # API keys (masked and unmasked for reveal toggle)
       api_keys = {
           "Azure OpenAI Endpoint": {
               "masked": mask_key(settings.azure_openai_endpoint, 10),
               "value": settings.azure_openai_endpoint,
               "configured": bool(settings.azure_openai_endpoint),
           },
           "Azure OpenAI API Key": {
               "masked": mask_key(settings.azure_openai_api_key),
               "value": settings.azure_openai_api_key,
               "configured": bool(settings.azure_openai_api_key),
           },
           "Azure OpenAI Deployment": {
               "masked": settings.azure_openai_deployment,  # Not sensitive
               "value": settings.azure_openai_deployment,
               "configured": bool(settings.azure_openai_deployment),
           },
           "Microsoft Tenant ID": {
               "masked": mask_key(settings.azure_tenant_id, 8),
               "value": settings.azure_tenant_id,
               "configured": bool(settings.azure_tenant_id),
           },
           "Microsoft Client ID": {
               "masked": mask_key(settings.azure_client_id, 8),
               "value": settings.azure_client_id,
               "configured": bool(settings.azure_client_id),
           },
           "Microsoft Client Secret": {
               "masked": mask_key(settings.azure_client_secret),
               "value": settings.azure_client_secret,
               "configured": bool(settings.azure_client_secret),
           },
           "Apify Token": {
               "masked": mask_key(settings.apify_token),
               "value": settings.apify_token,
               "configured": bool(settings.apify_token),
           },
           "Sender Email": {
               "masked": settings.sender_email,  # Email not sensitive
               "value": settings.sender_email,
               "configured": bool(settings.sender_email),
           },
       }

       # Relevance scoring config
       relevance_config = {
           "use_ai_relevance_scoring": settings.use_ai_relevance_scoring,
           "relevance_keyword_threshold": settings.relevance_keyword_threshold,
           "relevance_ai_batch_size": settings.relevance_ai_batch_size,
       }

       return templates.TemplateResponse(
           "admin/settings.html",
           {
               "request": request,
               "username": username,
               "active": "settings",
               "branding": branding,
               "scraping_config": scraping_config,
               "api_keys": api_keys,
               "relevance_config": relevance_config,
               "use_llm_summary": settings.use_llm_summary,
           }
       )
   ```
  </action>
  <verify>
python -c "from app.routers.admin import router; print('settings' in str([r.path for r in router.routes]))"
  </verify>
  <done>Admin router has settings page endpoint with config data</done>
</task>

<task type="auto">
  <name>Task 2: Create settings page template with masked keys</name>
  <files>app/templates/admin/settings.html</files>
  <action>
1. Create app/templates/admin/settings.html:
   - Extend base.html, title="Settings", active="settings"

2. Company branding section:
   ```html
   <h2>Settings</h2>
   <p class="text-muted">View system configuration. Settings are configured via environment variables.</p>

   <div class="card mb-4">
       <div class="card-header">Company Branding</div>
       <div class="card-body">
           <dl class="row mb-0">
               <dt class="col-sm-4">Company Name</dt>
               <dd class="col-sm-8">{{ branding.company_name }}</dd>

               <dt class="col-sm-4">Classification Level</dt>
               <dd class="col-sm-8">
                   <span class="badge bg-danger">{{ branding.classification_level }}</span>
               </dd>
           </dl>
           <small class="text-muted mt-2 d-block">
               Set via: <code>COMPANY_NAME</code>
           </small>
       </div>
   </div>
   ```

3. Scraping configuration section:
   ```html
   <div class="card mb-4">
       <div class="card-header">Scraping Configuration</div>
       <div class="card-body">
           <dl class="row mb-0">
               <dt class="col-sm-4">Batch Size</dt>
               <dd class="col-sm-8">{{ scraping_config.batch_size }} insurers/batch</dd>

               <dt class="col-sm-4">Batch Delay</dt>
               <dd class="col-sm-8">{{ scraping_config.batch_delay_seconds }} seconds</dd>

               <dt class="col-sm-4">Max Concurrent Sources</dt>
               <dd class="col-sm-8">{{ scraping_config.max_concurrent_sources }}</dd>

               <dt class="col-sm-4">Scrape Timeout</dt>
               <dd class="col-sm-8">{{ scraping_config.scrape_timeout_seconds }} seconds</dd>

               <dt class="col-sm-4">Max Results/Insurer</dt>
               <dd class="col-sm-8">{{ scraping_config.scrape_max_results }}</dd>
           </dl>
           <small class="text-muted mt-2 d-block">
               Set via: <code>BATCH_SIZE</code>, <code>BATCH_DELAY_SECONDS</code>, etc.
           </small>
       </div>
   </div>
   ```

4. AI/LLM settings section:
   ```html
   <div class="card mb-4">
       <div class="card-header">AI Configuration</div>
       <div class="card-body">
           <dl class="row mb-0">
               <dt class="col-sm-4">LLM Summary</dt>
               <dd class="col-sm-8">
                   {% if use_llm_summary %}
                   <span class="badge bg-success">Enabled</span>
                   {% else %}
                   <span class="badge bg-secondary">Disabled</span>
                   {% endif %}
               </dd>

               <dt class="col-sm-4">AI Relevance Scoring</dt>
               <dd class="col-sm-8">
                   {% if relevance_config.use_ai_relevance_scoring %}
                   <span class="badge bg-success">Enabled</span>
                   {% else %}
                   <span class="badge bg-secondary">Disabled</span>
                   {% endif %}
               </dd>

               <dt class="col-sm-4">Keyword Threshold</dt>
               <dd class="col-sm-8">{{ relevance_config.relevance_keyword_threshold }} items</dd>

               <dt class="col-sm-4">AI Batch Size</dt>
               <dd class="col-sm-8">{{ relevance_config.relevance_ai_batch_size }} items</dd>
           </dl>
       </div>
   </div>
   ```

5. API keys section with reveal toggle:
   ```html
   <div class="card mb-4">
       <div class="card-header d-flex justify-content-between align-items-center">
           <span>API Keys</span>
           <small class="text-muted">Read-only display</small>
       </div>
       <div class="card-body">
           {% for key_name, key_data in api_keys.items() %}
           <div class="mb-3">
               <label class="form-label d-flex justify-content-between">
                   <span>{{ key_name }}</span>
                   {% if key_data.configured %}
                   <span class="badge bg-success">Configured</span>
                   {% else %}
                   <span class="badge bg-warning">Not configured</span>
                   {% endif %}
               </label>
               <div class="input-group">
                   <input type="password"
                          class="form-control"
                          id="key-{{ loop.index }}"
                          value="{{ key_data.value }}"
                          readonly
                          data-masked="{{ key_data.masked }}">
                   <button class="btn btn-outline-secondary" type="button"
                           onclick="toggleKeyVisibility(this, 'key-{{ loop.index }}')">
                       <span class="show-text">Show</span>
                       <span class="hide-text d-none">Hide</span>
                   </button>
               </div>
           </div>
           {% endfor %}
       </div>
   </div>
   ```

6. JavaScript for key reveal toggle:
   ```javascript
   function toggleKeyVisibility(btn, inputId) {
       const input = document.getElementById(inputId);
       const showText = btn.querySelector('.show-text');
       const hideText = btn.querySelector('.hide-text');

       if (input.type === 'password') {
           input.type = 'text';
           showText.classList.add('d-none');
           hideText.classList.remove('d-none');
       } else {
           input.type = 'password';
           showText.classList.remove('d-none');
           hideText.classList.add('d-none');
       }
   }
   ```

7. Environment variable reference:
   ```html
   <div class="card">
       <div class="card-header">Environment Variable Reference</div>
       <div class="card-body">
           <p class="text-muted mb-2">All settings are configured via <code>.env</code> file or environment variables.</p>
           <a href="https://github.com/your-repo/docs/configuration.md" class="btn btn-outline-primary btn-sm" target="_blank">
               View Configuration Documentation
           </a>
       </div>
   </div>
   ```
  </action>
  <verify>
dir app\templates\admin\settings.html
  </verify>
  <done>Settings page template with masked API keys and reveal toggle</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete admin interface with all 6 pages: Dashboard, Insurers, Import, Recipients, Schedules, Settings</what-built>
  <how-to-verify>
1. Start the server: uvicorn app.main:app --reload
2. Navigate to http://localhost:8000/admin
3. Enter credentials (admin/changeme or configured values)
4. Verify each page:
   - Dashboard: 3 category cards, system status, recent reports
   - Insurers: Category tabs, search works, bulk enable/disable
   - Import: Drag-drop zone accepts files, preview shows, commit works
   - Recipients: Shows current TO/CC/BCC per category
   - Schedules: Toggle enables/disables, Run Now triggers job
   - Settings: Shows config values, API keys masked, reveal works
5. Test HTMX interactions don't cause full page reloads
  </how-to-verify>
  <resume-signal>Type "approved" to mark phase complete, or describe any issues to address</resume-signal>
</task>

</tasks>

<verification>
1. Settings page shows company name - ADMN-14
2. Settings page shows classification level - ADMN-14
3. Settings page shows batch size, timeout - ADMN-15
4. API keys shown masked by default - ADMN-16
5. Reveal toggle shows/hides actual values - ADMN-16
6. All settings display current environment values
</verification>

<success_criteria>
- ADMN-14 (company branding settings) fully met
- ADMN-15 (scraping config) fully met
- ADMN-16 (masked API keys with reveal) fully met
- Complete admin interface functional and verified
- All ADMN requirements addressed across plans 01-06
</success_criteria>

<output>
After completion, create `.planning/phases/08-admin-interface/08-06-SUMMARY.md`
</output>
