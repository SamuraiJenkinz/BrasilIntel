---
phase: 07-scheduling-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/scheduler_service.py
  - app/config.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Scheduler service creates 3 default jobs on startup"
    - "Jobs use São Paulo timezone for scheduling"
    - "Jobs persist across application restarts"
    - "Schedule configuration stored in Settings"
  artifacts:
    - path: "app/services/scheduler_service.py"
      provides: "APScheduler singleton with job management"
      min_lines: 150
      exports: ["SchedulerService"]
    - path: "app/config.py"
      provides: "Schedule configuration settings"
      contains: "schedule_"
  key_links:
    - from: "app/services/scheduler_service.py"
      to: "app/config.py"
      via: "get_settings() import"
      pattern: "from app.config import get_settings"
    - from: "app/services/scheduler_service.py"
      to: "SQLAlchemyJobStore"
      via: "job persistence"
      pattern: "SQLAlchemyJobStore"
---

<objective>
Create the core SchedulerService singleton that manages APScheduler for automated category runs.

Purpose: This is the foundation for all scheduling functionality. The service wraps APScheduler with São Paulo timezone, SQLite job persistence, and methods for job management (start, stop, pause, resume, reschedule).

Output: A working scheduler service that can create and manage scheduled jobs for the three product categories.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-scheduling-automation/07-RESEARCH.md

# Existing code to integrate with
@app/config.py
@app/routers/runs.py
@app/database.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add APScheduler dependencies and extend config</name>
  <files>requirements.txt, app/config.py</files>
  <action>
1. Update requirements.txt to ensure APScheduler and tzdata are present:
   - APScheduler>=3.10.4
   - tzdata>=2024.2 (Windows timezone data)

2. Extend Settings class in app/config.py with schedule configuration:
   ```python
   # Scheduler settings
   scheduler_enabled: bool = True
   schedule_health_cron: str = "0 6 * * *"  # 6:00 AM São Paulo
   schedule_dental_cron: str = "0 7 * * *"  # 7:00 AM São Paulo
   schedule_group_life_cron: str = "0 8 * * *"  # 8:00 AM São Paulo
   schedule_health_enabled: bool = True
   schedule_dental_enabled: bool = True
   schedule_group_life_enabled: bool = True
   scheduler_misfire_grace_time: int = 3600  # 1 hour grace
   scheduler_coalesce: bool = True  # Combine missed runs
   scheduler_max_instances: int = 1  # Prevent overlap
   ```

3. Add helper method to Settings:
   ```python
   def get_schedule_config(self, category: str) -> dict:
       """Get schedule configuration for a category."""
       config_map = {
           "Health": {
               "cron": self.schedule_health_cron,
               "enabled": self.schedule_health_enabled,
           },
           "Dental": {
               "cron": self.schedule_dental_cron,
               "enabled": self.schedule_dental_enabled,
           },
           "Group Life": {
               "cron": self.schedule_group_life_cron,
               "enabled": self.schedule_group_life_enabled,
           },
       }
       return config_map.get(category, {"cron": "0 6 * * *", "enabled": False})
   ```
  </action>
  <verify>
- `pip install -r requirements.txt` succeeds
- `python -c "from app.config import get_settings; s = get_settings(); print(s.schedule_health_cron)"` prints "0 6 * * *"
- `python -c "from app.config import get_settings; s = get_settings(); print(s.get_schedule_config('Health'))"` returns dict with cron and enabled keys
  </verify>
  <done>Config has all schedule settings and get_schedule_config() returns proper configuration per category.</done>
</task>

<task type="auto">
  <name>Task 2: Create SchedulerService singleton</name>
  <files>app/services/scheduler_service.py</files>
  <action>
Create app/services/scheduler_service.py with the SchedulerService class:

1. Import required modules:
   - `from apscheduler.schedulers.asyncio import AsyncIOScheduler`
   - `from apscheduler.jobstores.sqlalchemy import SQLAlchemyJobStore`
   - `from apscheduler.triggers.cron import CronTrigger`
   - `from apscheduler.events import EVENT_JOB_EXECUTED, EVENT_JOB_ERROR`
   - `from zoneinfo import ZoneInfo`
   - `import httpx`
   - `import logging`

2. Implement singleton pattern using __new__ and class variables:
   ```python
   _instance: Optional["SchedulerService"] = None
   _scheduler: Optional[AsyncIOScheduler] = None
   ```

3. Constants:
   - `SAO_PAULO_TZ = ZoneInfo("America/Sao_Paulo")`
   - `CATEGORIES = ["Health", "Dental", "Group Life"]`
   - Job ID pattern: `category_run_{category_slug}` (e.g., "category_run_health")

4. __init__ method:
   - Initialize SQLAlchemyJobStore pointing to `sqlite:///./data/brasilintel.db` with tablename `apscheduler_jobs`
   - Configure job_defaults: coalesce=True, max_instances=1, misfire_grace_time=3600
   - Create AsyncIOScheduler with São Paulo timezone
   - Add event listener for job execution logging

5. Core methods:
   - `get_job_id(category: str) -> str`: Convert category to job ID
   - `start() -> None`: Start scheduler, call _ensure_default_jobs()
   - `shutdown(wait: bool = False) -> None`: Graceful shutdown
   - `_ensure_default_jobs() -> None`: Create jobs for all 3 categories if not exist
   - `_job_listener(event) -> None`: Log job success/failure

6. Job execution method (async):
   ```python
   async def _execute_category_run(self, category: str) -> None:
       """Trigger category run via internal HTTP call."""
       logger.info(f"Scheduled run starting for category: {category}")
       try:
           async with httpx.AsyncClient() as client:
               response = await client.post(
                   "http://localhost:8000/api/runs/execute/category",
                   json={
                       "category": category,
                       "send_email": True,
                       "enabled_only": True
                   },
                   timeout=1800.0  # 30 minute timeout
               )
               response.raise_for_status()
               result = response.json()
               logger.info(f"Scheduled run completed for {category}")
       except Exception as e:
           logger.error(f"Scheduled run failed for {category}: {e}")
           raise
   ```

7. Management methods:
   - `get_schedule(category: str) -> Optional[dict]`: Get job info (enabled, next_run_time, trigger)
   - `get_all_schedules() -> list[dict]`: All category schedules
   - `update_schedule(category, hour, minute, cron_expression) -> dict`: Reschedule job
   - `pause_job(category: str) -> dict`: Pause scheduled job
   - `resume_job(category: str) -> dict`: Resume paused job
   - `trigger_now(category: str) -> None`: Trigger immediate execution

IMPORTANT PATTERNS FROM RESEARCH:
- Always use `replace_existing=True` when adding jobs
- Always pass explicit timezone to CronTrigger
- Use `CronTrigger.from_crontab(cron_str, timezone=SAO_PAULO_TZ)` for cron strings
- Check `if not self._scheduler.running` before start()
  </action>
  <verify>
```python
# Test scheduler service initialization
python -c "
from app.services.scheduler_service import SchedulerService
svc = SchedulerService()
print(f'Scheduler created: {svc._scheduler is not None}')
print(f'Timezone: {svc.SAO_PAULO_TZ}')
print(f'Job ID for Health: {svc.get_job_id(\"Health\")}')
"
```
Expected output:
- Scheduler created: True
- Timezone: America/Sao_Paulo
- Job ID for Health: category_run_health
  </verify>
  <done>SchedulerService singleton exists with all management methods, São Paulo timezone, and SQLite job persistence.</done>
</task>

<task type="auto">
  <name>Task 3: Add httpx dependency and verify integration</name>
  <files>requirements.txt</files>
  <action>
1. Add httpx to requirements.txt if not present:
   ```
   httpx>=0.27.0
   ```

2. Run pip install to ensure all dependencies are available:
   ```bash
   pip install -r requirements.txt
   ```

3. Create a simple test script to verify the scheduler can be instantiated and methods work:
   ```python
   # tests/test_scheduler_service.py
   import pytest
   from app.services.scheduler_service import SchedulerService

   def test_singleton_pattern():
       """Verify singleton returns same instance."""
       svc1 = SchedulerService()
       svc2 = SchedulerService()
       assert svc1 is svc2

   def test_job_id_generation():
       """Verify job IDs are correctly formatted."""
       svc = SchedulerService()
       assert svc.get_job_id("Health") == "category_run_health"
       assert svc.get_job_id("Dental") == "category_run_dental"
       assert svc.get_job_id("Group Life") == "category_run_group_life"

   def test_timezone_configured():
       """Verify São Paulo timezone is set."""
       svc = SchedulerService()
       assert str(svc.SAO_PAULO_TZ) == "America/Sao_Paulo"

   def test_scheduler_not_running_initially():
       """Verify scheduler doesn't auto-start."""
       svc = SchedulerService()
       assert not svc._scheduler.running
   ```

4. Run the tests:
   ```bash
   pytest tests/test_scheduler_service.py -v
   ```
  </action>
  <verify>
- `pip install -r requirements.txt` completes without errors
- `pytest tests/test_scheduler_service.py -v` shows 4 passing tests
  </verify>
  <done>All dependencies installed and scheduler service tests pass, confirming singleton pattern, job ID generation, and timezone configuration.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `pip install -r requirements.txt` succeeds
2. `python -c "from app.services.scheduler_service import SchedulerService; print(SchedulerService())"` works
3. `python -c "from app.config import get_settings; print(get_settings().schedule_health_cron)"` returns "0 6 * * *"
4. `pytest tests/test_scheduler_service.py -v` passes all tests
</verification>

<success_criteria>
- SchedulerService singleton exists in app/services/scheduler_service.py
- Settings extended with schedule configuration fields
- APScheduler and tzdata dependencies present
- Job ID pattern: category_run_{category_slug}
- São Paulo timezone configured for all scheduling operations
- SQLAlchemyJobStore configured for job persistence
- Unit tests pass for basic scheduler functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-scheduling-automation/07-01-SUMMARY.md`
</output>
